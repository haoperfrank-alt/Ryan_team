<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>å†›äº‹èŒä½ç®¡ç†ç³»ç»Ÿ - äº‘ç«¯å¤šè®¾å¤‡ç‰ˆ</title>
<style>
/* ä¿æŒæ‰€æœ‰åŸæœ‰CSSä¸å˜ */
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
body{background:linear-gradient(135deg,#1a237e 0%,#283593 100%);min-height:100vh;padding:20px;display:flex;justify-content:center;align-items:center}
#authContainer{max-width:400px;background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.3);overflow:hidden}
.auth-header{background:linear-gradient(to right,#d32f2f,#b71c1c);color:white;padding:30px;text-align:center}
.auth-body{padding:40px 30px}
.auth-title{font-size:24px;color:#333;text-align:center;margin-bottom:10px;font-weight:bold}
.auth-subtitle{color:#666;text-align:center;margin-bottom:30px;font-size:14px}
.secret-input{position:relative;margin-bottom:25px}
.secret-input input{width:100%;padding:15px 20px;padding-left:50px;border:2px solid #ddd;border-radius:10px;font-size:16px;background:#f9f9f9}
.secret-input input:focus{border-color:#d32f2f;background:white;outline:none;box-shadow:0 0 0 3px rgba(211,47,47,0.1)}
.secret-icon{position:absolute;left:15px;top:50%;transform:translateY(-50%);color:#d32f2f;font-size:20px}
.auth-button{width:100%;padding:16px;background:linear-gradient(to right,#d32f2f,#b71c1c);color:white;border:none;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;margin-bottom:20px;transition:all 0.3s}
.auth-button:hover{background:linear-gradient(to right,#c62828,#a10f0f);transform:translateY(-2px);box-shadow:0 5px 15px rgba(211,47,47,0.3)}
.auth-note{background:#f8f9fa;padding:15px;border-radius:8px;border-left:4px solid #d32f2f;font-size:13px;color:#666;line-height:1.5}
.auth-error{color:#d32f2f;margin-top:10px;padding:10px;background:#ffebee;border-radius:5px;border:1px solid #ffcdd2;text-align:center;display:none}
.auth-success{color:#2e7d32;margin-top:10px;padding:10px;background:#e8f5e9;border-radius:5px;border:1px solid #c8e6c9;text-align:center;display:none}
.countdown{text-align:center;color:#666;font-size:12px;margin-top:15px}
.container{display:none;max-width:500px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);overflow:hidden}
.header{background:#1890ff;color:white;padding:20px;text-align:center}
.body{padding:30px}
.form-group{margin-bottom:20px}
label{display:block;margin-bottom:8px;color:#333;font-weight:bold}
input,select{width:100%;padding:12px;border:1px solid #ddd;border-radius:5px;font-size:16px}
input:focus,select:focus{border-color:#1890ff;outline:none;box-shadow:0 0 0 2px rgba(24,144,255,0.2)}
.btn{width:100%;padding:14px;background:#1890ff;color:white;border:none;border-radius:5px;font-size:16px;font-weight:bold;cursor:pointer;transition:background 0.3s}
.btn:hover{background:#096dd9}
.btn-success{background:#52c41a}
.btn-success:hover{background:#389e0d}
.btn-danger{background:#ff4d4f}
.btn-danger:hover{background:#d9363e}
.error{color:#ff4d4f;margin-top:10px;padding:10px;background:#fff2f0;border:1px solid #ffccc7;border-radius:5px;display:none}
.main-container{display:none;max-width:1200px;margin:0 auto}
.main-header{background:white;padding:15px 20px;margin-bottom:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:center}
.tabs{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
.tab{padding:12px 24px;background:white;border:1px solid #ddd;border-radius:5px;cursor:pointer;font-weight:bold;transition:all 0.3s}
.tab:hover{background:#f5f5f5}
.tab.active{background:#1890ff;color:white;border-color:#1890ff}
.content{background:white;padding:25px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);min-height:400px}
table{width:100%;border-collapse:collapse;margin-top:20px}
th{background:#fafafa;padding:12px;text-align:left;border-bottom:1px solid #ddd;font-weight:bold}
td{padding:12px;border-bottom:1px solid #f0f0f0}
tr:hover{background:#fafafa}
.badge{padding:4px 8px;border-radius:4px;font-size:12px;font-weight:bold;color:white;display:inline-block}
.action-btn{padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-size:14px;margin-right:5px}
.action-btn-primary{background:#1890ff;color:white}
.action-btn-danger{background:#ff4d4f;color:white}
.action-btn-success{background:#52c41a;color:white}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:20px;margin-bottom:30px}
.stat-card{background:white;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);text-align:center}
.stat-card .number{font-size:32px;font-weight:bold;color:#1890ff;margin-bottom:10px}
.stat-card .label{color:#666;font-size:14px}
.locked-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);display:flex;justify-content:center;align-items:center;z-index:9999;flex-direction:column;color:white;text-align:center;padding:20px}
.lock-icon{font-size:80px;margin-bottom:20px;color:#d32f2f}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:10000;justify-content:center;align-items:center}
.modal-content{background:white;padding:30px;border-radius:10px;width:90%;max-width:400px}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-title{font-size:20px;font-weight:bold}
.tab-content{display:none}

/* æ–°å¢ï¼šäº‘ç«¯åŒæ­¥ç›¸å…³æ ·å¼ */
.cloud-status {
    position: fixed;
    top: 10px;
    right: 10px;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    z-index: 10001;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.cloud-online {
    background: #52c41a;
    color: white;
    animation: pulse 2s infinite;
}

.cloud-offline {
    background: #fa8c16;
    color: white;
}

.cloud-error {
    background: #ff4d4f;
    color: white;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

.sync-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 5px;
}

.sync-green { background: #52c41a; }
.sync-yellow { background: #fa8c16; }
.sync-red { background: #ff4d4f; }

.device-badge {
    background: #1890ff;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    margin-left: 10px;
}

.realtime-notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    border-left: 4px solid #1890ff;
    z-index: 9998;
    animation: slideIn 0.3s ease;
    max-width: 300px;
    display: none;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.conflict-modal {
    background: #fff7e6;
    border: 2px solid #fa8c16;
    border-radius: 10px;
    padding: 20px;
    margin: 20px 0;
}

.conflict-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

/* æ•°æ®åŒæ­¥é¡µé¢æ ·å¼ */
.sync-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.sync-progress {
    height: 10px;
    background: #f0f0f0;
    border-radius: 5px;
    overflow: hidden;
    margin: 10px 0;
}

.sync-progress-bar {
    height: 100%;
    background: #52c41a;
    width: 0%;
    transition: width 0.3s;
}
</style>
</head>
<body>
<!-- äº‘ç«¯çŠ¶æ€æŒ‡ç¤ºå™¨ -->
<div id="cloudStatus" class="cloud-status cloud-offline">
    <span class="sync-indicator sync-red"></span>
    <span id="cloudStatusText">äº‘ç«¯ç¦»çº¿</span>
</div>

<!-- å®æ—¶é€šçŸ¥ -->
<div id="realtimeNotification" class="realtime-notification">
    <div style="font-weight:bold;margin-bottom:5px;">å®æ—¶æ›´æ–°</div>
    <div id="notificationMessage"></div>
</div>

<!-- åˆ›å»ºäº‘ç«¯æœåŠ¡å™¨å¯†ç éªŒè¯ -->
<div id="cloudCreatePasswordModal" class="modal">
<div class="modal-content"><div class="modal-header"><div class="modal-title">åˆ›å»ºäº‘ç«¯æœåŠ¡å™¨æƒé™éªŒè¯</div>
<button onclick="closeModal()" style="background:none;border:none;font-size:24px;cursor:pointer">Ã—</button></div>
<div class="form-group"><label>è¯·è¾“å…¥åˆ›å»ºæœåŠ¡å™¨å¯†ç </label><input type="password" id="cloudServerCreatePassword" placeholder="è¯·è¾“å…¥åˆ›å»ºæœåŠ¡å™¨å¯†ç "></div>
<button class="btn btn-success" onclick="checkCloudCreateServerPassword()">éªŒè¯å¯†ç </button>
<div class="error" id="cloudPasswordError" style="margin-top:10px"></div></div></div>

<!-- è¦†ç›–äº‘ç«¯æœåŠ¡å™¨ç¡®è®¤ -->
<div id="overwriteCloudModal" class="modal">
<div class="modal-content"><div class="modal-header"><div class="modal-title" style="color:#fa8c16">âš ï¸ è¦†ç›–äº‘ç«¯æœåŠ¡å™¨</div>
<button onclick="closeModal()" style="background:none;border:none;font-size:24px;cursor:pointer">Ã—</button></div>
<div style="margin-bottom:20px">
<p><strong>è­¦å‘Šï¼šè¯¥äº‘ç«¯è®¿é—®ç å·²å­˜åœ¨æœåŠ¡å™¨ï¼</strong></p>
<p style="margin:10px 0;color:#ff4d4f">è¦†ç›–å°†åˆ é™¤åŸæœ‰æœåŠ¡å™¨åŠå…¶æ‰€æœ‰æ•°æ®ï¼</p>
<div style="background:#fff7e6;padding:15px;border-radius:5px;margin:15px 0">
<p style="margin-bottom:5px"><strong>åŸæœ‰æœåŠ¡å™¨ä¿¡æ¯ï¼š</strong></p>
<p style="font-size:14px;margin:5px 0">æœåŠ¡å™¨åç§°: <span id="existingServerName">-</span></p>
<p style="font-size:14px;margin:5px 0">åˆ›å»ºæ—¶é—´: <span id="existingServerTime">-</span></p>
<p style="font-size:14px;margin:5px 0">åˆ›å»ºè€…: <span id="existingServerCreator">-</span></p>
<p style="font-size:14px;margin:5px 0">ç”¨æˆ·æ•°: <span id="existingServerUsers">0</span></p>
</div>
<p>æ˜¯å¦è¦†ç›–æ­¤æœåŠ¡å™¨ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼</p>
</div>
<div style="display:flex;gap:10px"><button class="btn btn-danger" onclick="confirmOverwriteCloudServer()">ç¡®è®¤è¦†ç›–</button>
<button class="btn" onclick="closeModal()" style="background:#ccc">å–æ¶ˆ</button></div></div></div>

<!-- æš—å·éªŒè¯é¡µé¢ -->
<div id="authContainer"><div class="auth-header"><h1 style="margin:0;font-size:28px">å†›äº‹èŒä½ç®¡ç†ç³»ç»Ÿ</h1><p style="margin:10px 0 0 0;opacity:0.9">æœºå¯†ç³»ç»Ÿ-éœ€éªŒè¯èº«ä»½</p></div>
<div class="auth-body"><div class="auth-title">èº«ä»½éªŒè¯</div><div class="auth-subtitle">è¯·è¾“å…¥è®¿é—®æš—å·ä»¥è¿›å…¥ç³»ç»Ÿ</div>
<div class="secret-input"><span class="secret-icon">ğŸ”</span><input type="text" id="secretCode" placeholder="è¯·è¾“å…¥è®¿é—®æš—å·" autocomplete="off"></div>
<button class="auth-button" onclick="verifySecretCode()">éªŒè¯èº«ä»½</button>
<div class="auth-note"><strong>âš ï¸ é‡è¦æç¤ºï¼š</strong><br>æœ¬ç³»ç»Ÿä¸ºæœºå¯†ç®¡ç†ç³»ç»Ÿï¼Œä»…ä¾›æˆæƒäººå‘˜ä½¿ç”¨<br>è¯·ç¡®ä¿æ‚¨å·²è·å¾—æ­£ç¡®çš„è®¿é—®æš—å·<br>è¿ç»­5æ¬¡è¾“å…¥é”™è¯¯å°†é”å®šç³»ç»Ÿ30åˆ†é’Ÿ</div>
<div class="auth-error" id="authError"></div><div class="auth-success" id="authSuccess">éªŒè¯æˆåŠŸï¼æ­£åœ¨è¿›å…¥ç³»ç»Ÿ...</div>
<div class="countdown" id="countdown">å‰©ä½™å°è¯•æ¬¡æ•°: <span id="attemptsLeft">5</span> æ¬¡</div></div></div>

<!-- åˆ›å»ºæœåŠ¡å™¨å¯†ç éªŒè¯ -->
<div id="passwordModal" class="modal">
<div class="modal-content"><div class="modal-header"><div class="modal-title">åˆ›å»ºæœåŠ¡å™¨æƒé™éªŒè¯</div>
<button onclick="closeModal()" style="background:none;border:none;font-size:24px;cursor:pointer">Ã—</button></div>
<div class="form-group"><label>è¯·è¾“å…¥åˆ›å»ºæœåŠ¡å™¨å¯†ç </label><input type="password" id="serverCreatePassword" placeholder="è¯·è¾“å…¥åˆ›å»ºæœåŠ¡å™¨å¯†ç "></div>
<button class="btn btn-success" onclick="checkCreateServerPassword()">éªŒè¯å¯†ç </button>
<div class="error" id="passwordError" style="margin-top:10px"></div></div></div>

<!-- åˆ é™¤æœåŠ¡å™¨ç¡®è®¤ -->
<div id="deleteModal" class="modal">
<div class="modal-content"><div class="modal-header"><div class="modal-title" style="color:#ff4d4f">âš ï¸ åˆ é™¤æœåŠ¡å™¨</div>
<button onclick="closeModal()" style="background:none;border:none;font-size:24px;cursor:pointer">Ã—</button></div>
<div style="margin-bottom:20px"><p><strong>è­¦å‘Šï¼šæ­¤æ“ä½œä¸å¯é€†è½¬ï¼</strong></p>
<p style="margin:10px 0">æ‚¨å³å°†åˆ é™¤æœåŠ¡å™¨ï¼š<strong id="deleteServerName">-</strong></p>
<p style="color:#ff4d4f">æ‰€æœ‰ç”¨æˆ·æ•°æ®ã€æ™‹å‡è®°å½•å°†è¢«æ°¸ä¹…åˆ é™¤ï¼</p></div>
<div class="form-group"><label>è¯·è¾“å…¥ç¡®è®¤å¯†ç </label><input type="password" id="deleteConfirmPassword" placeholder="è¯·è¾“å…¥æ‚¨çš„å¯†ç ç¡®è®¤"></div>
<div style="display:flex;gap:10px"><button class="btn btn-danger" onclick="confirmDeleteServer()">ç¡®è®¤åˆ é™¤</button>
<button class="btn" onclick="closeModal()" style="background:#ccc">å–æ¶ˆ</button></div></div></div>

<!-- ç™»å½•/è¿æ¥æœåŠ¡å™¨é¡µé¢ -->
<div class="container" id="loginContainer"><div class="header"><h1>å†›äº‹èŒä½ç®¡ç†ç³»ç»Ÿ</h1><p>å¤šäººåä½œç‰ˆæœ¬</p></div>
<div class="body"><div class="tabs" style="margin-bottom:30px"><div class="tab active" onclick="showTab(event, 'connect')">è¿æ¥æœåŠ¡å™¨</div>
<div class="tab" onclick="showTab(event, 'login')">ç”¨æˆ·ç™»å½•</div><div class="tab" onclick="showCreateServerPassword()">åˆ›å»ºæœåŠ¡å™¨</div>
<div class="tab" onclick="showTab(event, 'cloud')">äº‘ç«¯æœåŠ¡å™¨</div></div>
<div id="connectTab" class="tab-content"><h2 style="margin-bottom:20px">è¿æ¥åˆ°æœåŠ¡å™¨</h2>
<div class="form-group"><label>æœåŠ¡å™¨åç§°</label><select id="serverList"><option value="">é€‰æ‹©æœåŠ¡å™¨</option></select></div>
<button class="btn" onclick="connectServer()">è¿æ¥åˆ°æœåŠ¡å™¨</button><div class="error" id="connectError"></div></div>
<div id="loginTab" class="tab-content" style="display:none"><h2 style="margin-bottom:20px">ç”¨æˆ·ç™»å½•</h2>
<div class="form-group"><label>ç”¨æˆ·å</label><input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å"></div>
<div class="form-group"><label>å¯†ç </label><input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç "></div>
<button class="btn" onclick="login()">ç™»å½•</button><div class="error" id="loginError"></div></div>
<div id="cloudTab" class="tab-content" style="display:none"><h2 style="margin-bottom:20px">äº‘ç«¯æœåŠ¡å™¨</h2>
<div class="form-group"><label>äº‘ç«¯è®¿é—®ç </label><input type="text" id="cloudAccessCode" placeholder="è¾“å…¥äº‘ç«¯è®¿é—®ç ï¼ˆå¦‚ï¼šmilitary_123ï¼‰"></div>
<button class="btn btn-success" onclick="connectCloudServer()">è¿æ¥äº‘ç«¯æœåŠ¡å™¨</button>
<div class="error" id="cloudError" style="margin-top:10px"></div>
<div style="margin-top:20px;padding:15px;background:#f8f9fa;border-radius:8px">
<p style="margin-bottom:10px"><strong>äº‘ç«¯æœåŠ¡å™¨è¯´æ˜ï¼š</strong></p>
<p style="font-size:13px;color:#666;line-height:1.5">â€¢ æ‰€æœ‰è®¾å¤‡ä½¿ç”¨ç›¸åŒçš„è®¿é—®ç è¿æ¥åŒä¸€äº‘ç«¯æœåŠ¡å™¨<br>â€¢ æ•°æ®å®æ—¶åŒæ­¥ï¼Œæ”¯æŒå¤šäººåä½œ<br>â€¢ å¯è¦†ç›–å·²å­˜åœ¨çš„äº‘ç«¯æœåŠ¡å™¨</p>
</div></div></div></div>

<!-- åˆ›å»ºæœåŠ¡å™¨è¡¨å• -->
<div id="createServerForm" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:10000;justify-content:center;align-items:center">
<div style="background:white;padding:30px;border-radius:10px;width:90%;max-width:500px;max-height:90vh;overflow-y:auto">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<h2 style="margin:0">åˆ›å»ºæ–°æœåŠ¡å™¨</h2>
<button onclick="closeCreateServerForm()" style="background:none;border:none;font-size:24px;cursor:pointer">Ã—</button>
</div>
<div class="form-group"><label>æœåŠ¡å™¨ç±»å‹</label>
<select id="serverType" class="form-control" onchange="toggleServerType()">
    <option value="local">æœ¬åœ°æœåŠ¡å™¨ï¼ˆå•æœºä½¿ç”¨ï¼‰</option>
    <option value="cloud">äº‘ç«¯æœåŠ¡å™¨ï¼ˆå¤šè®¾å¤‡ä½¿ç”¨ï¼‰</option>
</select></div>
<div class="form-group"><label>æœåŠ¡å™¨åç§°</label><input type="text" id="serverName" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€å†›åŒº"></div>
<div id="cloudAccessField" style="display:none">
<div class="form-group"><label>äº‘ç«¯è®¿é—®ç </label><input type="text" id="cloudServerCode" placeholder="è®¾ç½®äº‘ç«¯è®¿é—®ç ï¼ˆå…¶ä»–è®¾å¤‡ä½¿ç”¨æ­¤ç è¿æ¥ï¼‰">
<small style="color:#666;display:block;margin-top:5px">å»ºè®®ä½¿ç”¨è‹±æ–‡ã€æ•°å­—å’Œä¸‹åˆ’çº¿ï¼Œå¦‚ï¼šarmy_base_001</small>
<div id="cloudCodeWarning" style="margin-top:10px;padding:10px;background:#fff7e6;border-radius:5px;border:1px solid #fa8c16;display:none">
<strong style="color:#fa8c16">âš ï¸ æ³¨æ„ï¼š</strong> è¯¥è®¿é—®ç å·²å­˜åœ¨æœåŠ¡å™¨ï¼Œåˆ›å»ºå°†è¦†ç›–åŸæœ‰æœåŠ¡å™¨ï¼
</div>
</div>
</div>
<div class="form-group"><label>ç®¡ç†å‘˜ç”¨æˆ·å</label><input type="text" id="adminUsername" placeholder="è®¾ç½®ç®¡ç†å‘˜ç”¨æˆ·å"></div>
<div class="form-group"><label>ç®¡ç†å‘˜å¯†ç </label><input type="password" id="adminPassword" placeholder="è®¾ç½®ç®¡ç†å‘˜å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰"></div>
<div class="form-group"><label>ç¡®è®¤å¯†ç </label><input type="password" id="confirmPassword" placeholder="å†æ¬¡è¾“å…¥å¯†ç "></div>
<button class="btn btn-success" onclick="createServer()">åˆ›å»ºæœåŠ¡å™¨</button><div class="error" id="createError"></div>
</div></div>

<!-- ä¸»ç³»ç»Ÿç•Œé¢ -->
<div class="main-container" id="mainContainer"><div class="main-header"><div><h2>å†›äº‹èŒä½ç®¡ç†ç³»ç»Ÿ <span id="serverTypeBadge" class="device-badge">æœ¬åœ°</span></h2>
<p style="color:#666;margin-top:5px">æœåŠ¡å™¨: <span id="currentServerName">æœªè¿æ¥</span> | ç”¨æˆ·: <span id="currentUserName">æœªç™»å½•</span> | åŒæ­¥: <span id="syncStatus">-</span></p></div>
<div><button class="btn" onclick="syncNow()" style="margin-right:10px;width:auto">ğŸ”„ åŒæ­¥</button><button class="btn btn-danger" onclick="logout()" style="width:auto">é€€å‡º</button></div></div>
<div class="tabs"><div class="tab active" onclick="showMainTab(event, 'dashboard')">æ§åˆ¶é¢æ¿</div>
<div class="tab" onclick="showMainTab(event, 'personnel')">äººå‘˜ç®¡ç†</div><div class="tab" onclick="showMainTab(event, 'addPerson')">æ·»åŠ äººå‘˜</div>
<div class="tab" onclick="showMainTab(event, 'promotion')">æ™‹å‡ç®¡ç†</div><div class="tab" onclick="showMainTab(event, 'users')">ç”¨æˆ·ç®¡ç†</div>
<div class="tab" onclick="showMainTab(event, 'serverSettings')">æœåŠ¡å™¨è®¾ç½®</div>
<div class="tab" onclick="showMainTab(event, 'cloudSync')">äº‘ç«¯åŒæ­¥</div></div>
<div class="content"><div id="dashboardTab" class="main-tab"><h2 style="margin-bottom:20px">ç³»ç»Ÿæ¦‚è§ˆ</h2>
<div class="stats"><div class="stat-card"><div class="number" id="totalUsers">0</div><div class="label">æ€»äººæ•°</div></div>
<div class="stat-card"><div class="number" id="activeUsers">0</div><div class="label">åœ¨å½¹äººå‘˜</div></div>
<div class="stat-card"><div class="number" id="totalRanks">6</div><div class="label">å†›è¡”ç­‰çº§</div></div>
<div class="stat-card"><div class="number" id="adminCount">1</div><div class="label">ç®¡ç†å‘˜</div></div></div>
<h3 style="margin:30px 0 20px 0">æœ€è¿‘æ“ä½œ</h3><div id="recentActions" style="background:#fafafa;padding:20px;border-radius:5px;min-height:100px">
<p style="color:#999;text-align:center">æš‚æ— æ“ä½œè®°å½•</p></div>
<!-- åœ¨çº¿è®¾å¤‡æ˜¾ç¤º -->
<div id="onlineDevicesSection" style="margin-top:30px;padding:20px;background:#e6f7ff;border-radius:10px;display:none">
<h4 style="margin-bottom:15px">ğŸ–¥ï¸ åœ¨çº¿è®¾å¤‡</h4>
<div id="onlineDevicesList"></div>
</div></div>
<div id="personnelTab" class="main-tab" style="display:none"><h2 style="margin-bottom:20px">äººå‘˜ç®¡ç†</h2>
<div style="margin-bottom:20px;padding:15px;background:#e6f7ff;border-radius:5px;border-left:4px solid #1890ff">æ‚¨å¯ä»¥ç®¡ç†å†›è¡”ä½äºæ‚¨çš„äººå‘˜</div>
<table><thead><tr><th>å§“å</th><th>å†›è¡”</th><th>çŠ¶æ€</th><th>åŠ å…¥æ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody id="personnelList"></tbody></table></div>
<div id="addPersonTab" class="main-tab" style="display:none"><h2 style="margin-bottom:20px">æ·»åŠ äººå‘˜</h2>
<div style="max-width:500px"><div class="form-group"><label>å§“å</label><input type="text" id="newName" placeholder="è¾“å…¥äººå‘˜å§“å"></div>
<div class="form-group"><label>åˆå§‹å¯†ç </label><input type="text" id="newPassword" placeholder="è®¾ç½®åˆå§‹å¯†ç "></div>
<div class="form-group"><label>åˆå§‹å†›è¡”</label><select id="newRank"><option value="0">åºŸç‰©</option><option value="1">å°å…µ</option>
<option value="2">å¤§å…µ</option><option value="3">å›¢é•¿</option><option value="4">å†›é•¿</option><option value="5">ä¸»å¸…</option></select></div>
<button class="btn btn-success" onclick="addNewPerson()">æ·»åŠ äººå‘˜</button><div class="error" id="addError" style="margin-top:20px"></div></div></div>
<div id="promotionTab" class="main-tab" style="display:none"><h2 style="margin-bottom:20px">æ™‹å‡ç®¡ç†</h2>
<div style="max-width:500px"><div class="form-group"><label>é€‰æ‹©äººå‘˜</label><select id="promotePerson"><option value="">è¯·é€‰æ‹©äººå‘˜</option></select></div>
<div class="form-group"><label>æ“ä½œç±»å‹</label><select id="promoteAction"><option value="up">æ™‹å‡ä¸€çº§</option><option value="down">é™çº§ä¸€çº§</option></select></div>
<div id="promoteInfo" style="padding:15px;background:#f6ffed;border-radius:5px;margin-bottom:20px;display:none">
<p><strong>å½“å‰å†›è¡”:</strong> <span id="currentRankText">-</span></p><p><strong>æ“ä½œåå†›è¡”:</strong> <span id="newRankText">-</span></p></div>
<button class="btn" onclick="promotePerson()">æ‰§è¡Œæ“ä½œ</button><div class="error" id="promoteError" style="margin-top:20px"></div></div></div>
<div id="usersTab" class="main-tab" style="display:none"><h2 style="margin-bottom:20px">ç”¨æˆ·ç®¡ç†</h2>
<table><thead><tr><th>ç”¨æˆ·å</th><th>å†›è¡”</th><th>æœ€åç™»å½•</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead><tbody id="usersList"></tbody></table></div>
<div id="serverSettingsTab" class="main-tab" style="display:none"><h2 style="margin-bottom:20px">æœåŠ¡å™¨è®¾ç½®</h2>
<div style="background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:20px">
<h3 style="margin-bottom:15px">å½“å‰æœåŠ¡å™¨ä¿¡æ¯</h3><p>æœåŠ¡å™¨åç§°: <strong id="serverSettingsName">-</strong></p>
<p>æœåŠ¡å™¨ç±»å‹: <span id="serverSettingsType">æœ¬åœ°</span></p>
<p>åˆ›å»ºæ—¶é—´: <span id="serverSettingsTime">-</span></p><p>åˆ›å»ºè€…: <span id="serverSettingsCreator">-</span></p>
<p>æ€»ç”¨æˆ·æ•°: <span id="serverSettingsUsers">0</span></p>
<p>äº‘ç«¯è®¿é—®ç : <code id="serverCloudCode" style="background:#f0f0f0;padding:2px 8px;border-radius:3px">æ— </code></p>
</div>
<div style="background:#ffebee;padding:20px;border-radius:10px"><h3 style="color:#ff4d4f;margin-bottom:15px">å±é™©æ“ä½œ</h3>
<p style="margin-bottom:15px">åˆ é™¤æœåŠ¡å™¨å°†æ°¸ä¹…æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼</p>
<button class="btn btn-danger" onclick="showDeleteModal()" id="deleteServerBtn" disabled>åˆ é™¤æœåŠ¡å™¨</button>
<p style="color:#666;font-size:12px;margin-top:10px">åªæœ‰æœåŠ¡å™¨åˆ›å»ºè€…å¯ä»¥åˆ é™¤æœåŠ¡å™¨</p></div></div>
<div id="cloudSyncTab" class="main-tab" style="display:none"><h2 style="margin-bottom:20px">äº‘ç«¯åŒæ­¥ç®¡ç†</h2>
<div class="sync-section">
<h3>å½“å‰åŒæ­¥çŠ¶æ€</h3>
<p>æœåŠ¡å™¨ç±»å‹: <strong id="syncServerType">æœ¬åœ°æœåŠ¡å™¨</strong></p>
<p>åŒæ­¥çŠ¶æ€: <span id="syncStatusDetail" style="color:#ff4d4f">æœªè¿æ¥</span></p>
<p>æœ€ååŒæ­¥æ—¶é—´: <span id="lastSyncTime">ä»æœªåŒæ­¥</span></p>
<p>åœ¨çº¿è®¾å¤‡æ•°: <span id="deviceCount">1</span></p>
</div>
<div class="sync-section">
<h3>äº‘ç«¯åŒæ­¥æ§åˆ¶</h3>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:15px">
<button class="btn btn-success" onclick="enableCloudSync()" id="enableSyncBtn">å¯ç”¨äº‘ç«¯åŒæ­¥</button>
<button class="btn" onclick="disableCloudSync()" id="disableSyncBtn" style="background:#f0f0f0">ç¦ç”¨äº‘ç«¯åŒæ­¥</button>
</div>
<button class="btn btn-primary" onclick="forceSync()" style="margin-top:15px;width:100%">ğŸ”„ å¼ºåˆ¶åŒæ­¥æ•°æ®</button>
</div>
<div class="sync-section">
<h3>æ•°æ®è¿ç§»</h3>
<p style="color:#666;margin-bottom:15px">å°†æœ¬åœ°æœåŠ¡å™¨æ•°æ®è¿ç§»åˆ°äº‘ç«¯</p>
<button class="btn" onclick="migrateToCloud()" style="background:#722ed1;color:white">æœ¬åœ° â†’ äº‘ç«¯</button>
<button class="btn" onclick="migrateFromCloud()" style="background:#9254de;color:white;margin-left:10px">äº‘ç«¯ â†’ æœ¬åœ°</button>
</div>
</div></div></div>

<!-- å†²çªè§£å†³æ¨¡æ€æ¡† -->
<div id="conflictModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<div class="modal-title" style="color:#fa8c16;">âš ï¸ æ•°æ®å†²çª</div>
<button onclick="closeModal()" style="background:none;border:none;font-size:24px;cursor:pointer">Ã—</button>
</div>
<div class="conflict-modal">
<p><strong>æ£€æµ‹åˆ°æ•°æ®å†²çªï¼</strong></p>
<p id="conflictMessage" style="margin:10px 0;">å…¶ä»–è®¾å¤‡ä¿®æ”¹äº†ç›¸åŒçš„æ•°æ®ã€‚</p>
<div class="conflict-actions">
<button class="btn btn-primary" onclick="resolveConflict('local')">ä½¿ç”¨æœ¬åœ°æ•°æ®</button>
<button class="btn" onclick="resolveConflict('cloud')" style="background:#f0f0f0">ä½¿ç”¨äº‘ç«¯æ•°æ®</button>
<button class="btn btn-success" onclick="resolveConflict('merge')">åˆå¹¶æ•°æ®</button>
</div>
</div>
</div></div>

<!-- é”å®šå±å¹• -->
<div id="lockScreen" class="locked-screen" style="display:none"><div class="lock-icon">ğŸ”’</div><h2 style="margin-bottom:15px">ç³»ç»Ÿå·²é”å®š</h2>
<div class="lock-message">ç”±äºè¿ç»­å¤šæ¬¡è¾“å…¥é”™è¯¯æš—å·ï¼Œç³»ç»Ÿå·²è¢«é”å®šã€‚<br>è¯·åœ¨ <span id="lockTime">30:00</span> åé‡è¯•ã€‚</div>
<button class="btn" onclick="checkLockStatus()" style="background:#d32f2f;color:white;border:none;padding:12px 30px;border-radius:5px;font-size:16px;cursor:pointer">é‡æ–°éªŒè¯</button></div>

<script>
// ==================== åŸç³»ç»Ÿé…ç½® ====================
const SECRET_CODE = "èµµå·¦å´è”ç›Ÿ";
const CREATE_SERVER_PASSWORD = "1235";
const MAX_ATTEMPTS = 5;
const LOCK_TIME = 30 * 60 * 1000;
const ranks = [
    {id:0, name:"åºŸç‰©", color:"#8c8c8c"},
    {id:1, name:"å°å…µ", color:"#52c41a"},
    {id:2, name:"å¤§å…µ", color:"#1890ff"},
    {id:3, name:"å›¢é•¿", color:"#722ed1"},
    {id:4, name:"å†›é•¿", color:"#fa8c16"},
    {id:5, name:"ä¸»å¸…", color:"#f5222d"},
    {id:99, name:"ç®¡ç†å‘˜", color:"#eb2f96"}
];

// ==================== æ–°å¢ï¼šäº‘ç«¯é…ç½® ====================
const CLOUD_CONFIG = {
    // ä½¿ç”¨ GitHub Gists ä½œä¸ºäº‘ç«¯å­˜å‚¨ï¼ˆå®Œå…¨å…è´¹ï¼‰
    GITHUB_USERNAME: 'military_system',  // å¯ä»¥ä¿®æ”¹
    GIST_FILENAME: 'military_data.json',
    
    // äº‘ç«¯å­˜å‚¨é”®å‰ç¼€
    CLOUD_PREFIX: 'cloud_server_',
    
    // åŒæ­¥é—´éš”ï¼ˆæ¯«ç§’ï¼‰
    SYNC_INTERVAL: 10000, // 10ç§’
    
    // æœ€å¤§å†²çªé‡è¯•æ¬¡æ•°
    MAX_CONFLICT_RETRY: 3
};

// ==================== å…¨å±€å˜é‡ ====================
let currentUser = null;
let currentServer = null;
let serverData = { info: null, users: [], logs: [] };
let secretVerified = false;
let failedAttempts = 0;
let lockUntil = 0;

// æ–°å¢ï¼šäº‘ç«¯ç›¸å…³å˜é‡
let isCloudServer = false;
let cloudSyncEnabled = false;
let syncIntervalId = null;
let deviceId = null;
let lastSyncTime = null;
let pendingChanges = [];
let conflictData = null;

// æ–°å¢ï¼šè¦†ç›–æœåŠ¡å™¨ç›¸å…³å˜é‡
let pendingOverwriteCloudCode = null;
let pendingOverwriteServerName = null;
let existingCloudServerData = null;

// ==================== åŸç³»ç»Ÿåˆå§‹åŒ– ====================
document.addEventListener('DOMContentLoaded', function() {
    console.log('ç³»ç»Ÿåˆå§‹åŒ–...');
    
    // ç”Ÿæˆè®¾å¤‡ID
    deviceId = generateDeviceId();
    
    // æ£€æŸ¥é”å®šçŠ¶æ€
    checkLockStatus();
    loadAttempts();
    
    // åˆå§‹åŒ–äº‘ç«¯çŠ¶æ€
    initCloudStatus();
    
    // è®¾ç½®äº‹ä»¶ç›‘å¬
    document.getElementById('secretCode').addEventListener('keypress', e => {
        if (e.key === 'Enter') verifySecretCode();
    });
    document.getElementById('serverCreatePassword').addEventListener('keypress', e => {
        if (e.key === 'Enter') checkCreateServerPassword();
    });
    document.getElementById('cloudServerCreatePassword').addEventListener('keypress', e => {
        if (e.key === 'Enter') checkCloudCreateServerPassword();
    });
    document.getElementById('username').addEventListener('keypress', e => {
        if (e.key === 'Enter') login();
    });
    document.getElementById('password').addEventListener('keypress', e => {
        if (e.key === 'Enter') login();
    });
    document.getElementById('cloudAccessCode').addEventListener('keypress', e => {
        if (e.key === 'Enter') connectCloudServer();
    });
    
    // ç›‘å¬äº‘ç«¯è®¿é—®ç è¾“å…¥ï¼Œæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    document.getElementById('cloudServerCode')?.addEventListener('input', function() {
        checkCloudCodeExistence(this.value.trim());
    });
    
    document.getElementById('secretCode').focus();
});

// æ£€æŸ¥äº‘ç«¯è®¿é—®ç æ˜¯å¦å·²å­˜åœ¨
function checkCloudCodeExistence(cloudCode) {
    if (!cloudCode) {
        document.getElementById('cloudCodeWarning').style.display = 'none';
        return;
    }
    
    const existingCloudData = localStorage.getItem(CLOUD_CONFIG.CLOUD_PREFIX + cloudCode);
    const warningDiv = document.getElementById('cloudCodeWarning');
    
    if (existingCloudData) {
        try {
            const data = JSON.parse(existingCloudData);
            warningDiv.innerHTML = `<strong style="color:#fa8c16">âš ï¸ æ³¨æ„ï¼š</strong> è¯¥è®¿é—®ç å·²å­˜åœ¨æœåŠ¡å™¨ "${data.info?.name || 'æœªçŸ¥æœåŠ¡å™¨'}"ï¼Œåˆ›å»ºå°†è¦†ç›–åŸæœ‰æœåŠ¡å™¨ï¼`;
            warningDiv.style.display = 'block';
        } catch (e) {
            warningDiv.innerHTML = `<strong style="color:#fa8c16">âš ï¸ æ³¨æ„ï¼š</strong> è¯¥è®¿é—®ç å·²å­˜åœ¨æœåŠ¡å™¨ï¼Œåˆ›å»ºå°†è¦†ç›–åŸæœ‰æœåŠ¡å™¨ï¼`;
            warningDiv.style.display = 'block';
        }
    } else {
        warningDiv.style.display = 'none';
    }
}

// ==================== åŸç³»ç»Ÿå‡½æ•°ï¼ˆä¿æŒä¸å˜ï¼‰====================
function verifySecretCode() {
    if (!checkLockStatus()) return;
    
    const inputCode = document.getElementById('secretCode').value.trim();
    const errorDiv = document.getElementById('authError');
    const successDiv = document.getElementById('authSuccess');
    
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';
    
    if (!inputCode) {
        errorDiv.textContent = 'è¯·è¾“å…¥è®¿é—®æš—å·';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (inputCode === SECRET_CODE) {
        secretVerified = true;
        successDiv.textContent = 'éªŒè¯æˆåŠŸï¼æ­£åœ¨è¿›å…¥ç³»ç»Ÿ...';
        successDiv.style.display = 'block';
        failedAttempts = 0;
        saveAttempts();
        updateAttemptsDisplay();
        document.getElementById('secretCode').value = '';
        
        setTimeout(() => {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'block';
            loadServersList();
            checkAutoLogin();
        }, 1000);
    } else {
        failedAttempts++;
        saveAttempts();
        const attemptsLeft = MAX_ATTEMPTS - failedAttempts;
        
        if (attemptsLeft <= 0) {
            errorDiv.textContent = 'æš—å·é”™è¯¯æ¬¡æ•°è¿‡å¤šï¼Œç³»ç»Ÿå·²é”å®š30åˆ†é’Ÿï¼';
            errorDiv.style.display = 'block';
            lockSystem();
        } else {
            errorDiv.textContent = `æš—å·é”™è¯¯ï¼å‰©ä½™å°è¯•æ¬¡æ•°: ${attemptsLeft} æ¬¡`;
            errorDiv.style.display = 'block';
            document.getElementById('secretCode').value = '';
            document.getElementById('secretCode').focus();
            updateAttemptsDisplay();
        }
    }
}

function showCreateServerPassword() {
    if (!secretVerified) {
        alert('è¯·å…ˆé€šè¿‡æš—å·éªŒè¯');
        return;
    }
    document.getElementById('passwordModal').style.display = 'flex';
    document.getElementById('serverCreatePassword').value = '';
    document.getElementById('passwordError').style.display = 'none';
    document.getElementById('serverCreatePassword').focus();
}

function checkCreateServerPassword() {
    const password = document.getElementById('serverCreatePassword').value;
    const errorDiv = document.getElementById('passwordError');
    
    if (password === CREATE_SERVER_PASSWORD) {
        closeModal();
        showCreateServerForm();
    } else {
        errorDiv.textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·å’¨è¯¢ç³»ç»Ÿç®¡ç†å‘˜è·å–æ­£ç¡®å¯†ç ';
        errorDiv.style.display = 'block';
        document.getElementById('serverCreatePassword').value = '';
        document.getElementById('serverCreatePassword').focus();
    }
}

// æ–°å¢ï¼šäº‘ç«¯åˆ›å»ºæœåŠ¡å™¨å¯†ç éªŒè¯
function checkCloudCreateServerPassword() {
    const password = document.getElementById('cloudServerCreatePassword').value;
    const errorDiv = document.getElementById('cloudPasswordError');
    
    if (password === CREATE_SERVER_PASSWORD) {
        closeModal();
        // è·å–ä¹‹å‰ä¿å­˜çš„äº‘ç«¯è®¿é—®ç å’ŒæœåŠ¡å™¨åç§°
        const cloudCode = localStorage.getItem('pendingCloudCode');
        const serverName = localStorage.getItem('pendingServerName');
        
        if (cloudCode && serverName) {
            // æ¸…ç†ä¸´æ—¶å­˜å‚¨
            localStorage.removeItem('pendingCloudCode');
            localStorage.removeItem('pendingServerName');
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨äº‘ç«¯æœåŠ¡å™¨
            const existingCloudData = localStorage.getItem(CLOUD_CONFIG.CLOUD_PREFIX + cloudCode);
            
            if (existingCloudData) {
                try {
                    existingCloudServerData = JSON.parse(existingCloudData);
                    pendingOverwriteCloudCode = cloudCode;
                    pendingOverwriteServerName = serverName;
                    
                    // æ˜¾ç¤ºè¦†ç›–ç¡®è®¤æ¨¡æ€æ¡†
                    showOverwriteCloudModal(existingCloudServerData);
                } catch (e) {
                    // æ•°æ®è§£æå¤±è´¥ï¼Œç›´æ¥åˆ›å»º
                    createNewCloudServerAfterPassword(cloudCode, serverName);
                }
            } else {
                // ä¸å­˜åœ¨ï¼Œç›´æ¥åˆ›å»º
                createNewCloudServerAfterPassword(cloudCode, serverName);
            }
        } else {
            alert('æ•°æ®é”™è¯¯ï¼Œè¯·é‡è¯•');
        }
    } else {
        errorDiv.textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·å’¨è¯¢ç³»ç»Ÿç®¡ç†å‘˜è·å–æ­£ç¡®å¯†ç ';
        errorDiv.style.display = 'block';
        document.getElementById('cloudServerCreatePassword').value = '';
        document.getElementById('cloudServerCreatePassword').focus();
    }
}

// æ˜¾ç¤ºè¦†ç›–äº‘ç«¯æœåŠ¡å™¨ç¡®è®¤æ¨¡æ€æ¡†
function showOverwriteCloudModal(existingData) {
    document.getElementById('existingServerName').textContent = existingData.info?.name || 'æœªçŸ¥æœåŠ¡å™¨';
    document.getElementById('existingServerTime').textContent = existingData.info?.createdAt ? new Date(existingData.info.createdAt).toLocaleString('zh-CN') : 'æœªçŸ¥';
    document.getElementById('existingServerCreator').textContent = existingData.info?.createdBy || 'æœªçŸ¥';
    document.getElementById('existingServerUsers').textContent = existingData.users?.length || 0;
    
    document.getElementById('overwriteCloudModal').style.display = 'flex';
}

// ç¡®è®¤è¦†ç›–äº‘ç«¯æœåŠ¡å™¨
function confirmOverwriteCloudServer() {
    closeModal();
    
    if (pendingOverwriteCloudCode && pendingOverwriteServerName) {
        // æ¸…ç†æ—§æ•°æ®
        localStorage.removeItem(CLOUD_CONFIG.CLOUD_PREFIX + pendingOverwriteCloudCode);
        
        // åˆ›å»ºæ–°çš„äº‘ç«¯æœåŠ¡å™¨
        createNewCloudServerAfterPassword(pendingOverwriteCloudCode, pendingOverwriteServerName);
        
        // æ¸…ç†ä¸´æ—¶å˜é‡
        pendingOverwriteCloudCode = null;
        pendingOverwriteServerName = null;
        existingCloudServerData = null;
    }
}

function showCreateServerForm() {
    document.getElementById('createServerForm').style.display = 'flex';
    document.getElementById('serverName').value = '';
    document.getElementById('adminUsername').value = '';
    document.getElementById('adminPassword').value = '';
    document.getElementById('confirmPassword').value = '';
    document.getElementById('cloudServerCode').value = '';
    document.getElementById('serverType').value = 'local';
    toggleServerType();
    document.getElementById('createError').style.display = 'none';
    document.getElementById('cloudCodeWarning').style.display = 'none';
}

function toggleServerType() {
    const serverType = document.getElementById('serverType').value;
    const cloudAccessField = document.getElementById('cloudAccessField');
    
    if (serverType === 'cloud') {
        cloudAccessField.style.display = 'block';
    } else {
        cloudAccessField.style.display = 'none';
    }
}

// ==================== ä¿®æ”¹åˆ›å»ºæœåŠ¡å™¨å‡½æ•°ï¼Œå…è®¸è¦†ç›– ====================

function createServer() {
    if (!secretVerified) {
        alert('è¯·å…ˆé€šè¿‡æš—å·éªŒè¯');
        return;
    }
    
    const serverType = document.getElementById('serverType').value;
    const serverName = document.getElementById('serverName').value.trim();
    const adminUsername = document.getElementById('adminUsername').value.trim();
    const adminPassword = document.getElementById('adminPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const cloudServerCode = document.getElementById('cloudServerCode').value.trim();
    const errorDiv = document.getElementById('createError');
    errorDiv.style.display = 'none';
    
    // éªŒè¯è¾“å…¥
    if (!serverName || !adminUsername || !adminPassword || !confirmPassword) {
        errorDiv.textContent = 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (adminPassword !== confirmPassword) {
        errorDiv.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (adminPassword.length < 6) {
        errorDiv.textContent = 'å¯†ç è‡³å°‘éœ€è¦6ä½';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (serverType === 'cloud' && !cloudServerCode) {
        errorDiv.textContent = 'è¯·è®¾ç½®äº‘ç«¯è®¿é—®ç ';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (serverType === 'cloud' && !/^[a-zA-Z0-9_]+$/.test(cloudServerCode)) {
        errorDiv.textContent = 'äº‘ç«¯è®¿é—®ç åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿';
        errorDiv.style.display = 'block';
        return;
    }
    
    // æ£€æŸ¥äº‘ç«¯è®¿é—®ç æ˜¯å¦å·²å­˜åœ¨
    if (serverType === 'cloud') {
        const existingCloudData = localStorage.getItem(CLOUD_CONFIG.CLOUD_PREFIX + cloudServerCode);
        if (existingCloudData) {
            // å·²å­˜åœ¨ï¼Œè¯¢é—®æ˜¯å¦è¦†ç›–
            if (!confirm(`äº‘ç«¯è®¿é—®ç  "${cloudServerCode}" å·²å­˜åœ¨æœåŠ¡å™¨ï¼Œæ˜¯å¦è¦†ç›–åŸæœ‰æœåŠ¡å™¨ï¼Ÿ\n\nâš ï¸ è­¦å‘Šï¼šè¦†ç›–å°†åˆ é™¤åŸæœ‰æœåŠ¡å™¨åŠå…¶æ‰€æœ‰æ•°æ®ï¼`)) {
                return;
            }
            // ç”¨æˆ·ç¡®è®¤è¦†ç›–ï¼Œç»§ç»­åˆ›å»º
        }
    }
    
    // åˆ›å»ºæœåŠ¡å™¨
    const serverKey = serverType === 'cloud' ? cloudServerCode : ('key_' + Date.now() + '_' + Math.random().toString(36).substr(2, 8));
    const adminId = 'user_' + Date.now();
    
    serverData = {
        info: {
            id: 'server_' + Date.now(),
            name: serverName,
            key: serverKey,
            type: serverType,
            cloudCode: serverType === 'cloud' ? cloudServerCode : null,
            createdAt: new Date().toISOString(),
            createdBy: adminUsername,
            creatorId: adminId,
            lastSync: new Date().toISOString()
        },
        users: [{
            id: adminId,
            username: adminUsername,
            password: adminPassword,
            rank: 99,
            isAdmin: true,
            lastLogin: null,
            createdAt: new Date().toISOString(),
            name: "ç®¡ç†å‘˜",
            deviceId: deviceId
        }],
        logs: [{
            action: 'server_created',
            user: adminUsername,
            timestamp: new Date().toISOString(),
            details: `æœåŠ¡å™¨ "${serverName}" å·²åˆ›å»ºï¼ˆ${serverType === 'cloud' ? 'äº‘ç«¯' : 'æœ¬åœ°'}ï¼‰`
        }],
        devices: [{
            id: deviceId,
            user: adminUsername,
            lastSeen: new Date().toISOString(),
            online: true
        }]
    };
    
    // ä¿å­˜æœåŠ¡å™¨æ•°æ®
    if (serverType === 'cloud') {
        // äº‘ç«¯æœåŠ¡å™¨å­˜å‚¨åœ¨ç‰¹æ®Šå‰ç¼€ä¸‹
        localStorage.setItem(CLOUD_CONFIG.CLOUD_PREFIX + serverKey, JSON.stringify(serverData));
    } else {
        // æœ¬åœ°æœåŠ¡å™¨
        localStorage.setItem('server_' + serverKey, JSON.stringify(serverData));
    }
    
    localStorage.setItem('currentServerKey', serverKey);
    localStorage.setItem('currentUser', JSON.stringify({
        id: adminId,
        username: adminUsername,
        password: adminPassword
    }));
    
    currentUser = serverData.users[0];
    currentServer = {
        key: serverKey,
        name: serverName,
        type: serverType
    };
    
    // å¦‚æœæ˜¯äº‘ç«¯æœåŠ¡å™¨ï¼Œå¯åŠ¨åŒæ­¥
    if (serverType === 'cloud') {
        isCloudServer = true;
        cloudSyncEnabled = true;
        startCloudSync();
    }
    
    closeCreateServerForm();
    showMainSystem();
}

// ==================== è¿æ¥äº‘ç«¯æœåŠ¡å™¨ï¼ˆå…è®¸è¦†ç›–ï¼‰ ====================

// è¿æ¥äº‘ç«¯æœåŠ¡å™¨ï¼ˆä¿®å¤å®‰å…¨æ¼æ´ï¼‰
function connectCloudServer() {
    const cloudAccessCode = document.getElementById('cloudAccessCode').value.trim();
    const errorDiv = document.getElementById('cloudError');
    errorDiv.style.display = 'none';
    
    if (!cloudAccessCode) {
        errorDiv.textContent = 'è¯·è¾“å…¥äº‘ç«¯è®¿é—®ç ';
        errorDiv.style.display = 'block';
        return;
    }
    
    // æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰è¯¥äº‘ç«¯æœåŠ¡å™¨
    const cloudDataStr = localStorage.getItem(CLOUD_CONFIG.CLOUD_PREFIX + cloudAccessCode);
    
    if (cloudDataStr) {
        try {
            serverData = JSON.parse(cloudDataStr);
            currentServer = {
                key: cloudAccessCode,
                name: serverData.info.name,
                type: 'cloud'
            };
            isCloudServer = true;
            
            // åˆ‡æ¢åˆ°ç™»å½•é¡µé¢
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            tabs[1].classList.add('active');
            
            document.getElementById('cloudTab').style.display = 'none';
            document.getElementById('loginTab').style.display = 'block';
            
            showNotification('å·²è¿æ¥åˆ°äº‘ç«¯æœåŠ¡å™¨ï¼Œè¯·ç™»å½•');
            
        } catch (e) {
            errorDiv.textContent = 'äº‘ç«¯æœåŠ¡å™¨æ•°æ®æŸå';
            errorDiv.style.display = 'block';
        }
    } else {
        // ä¿®å¤å®‰å…¨æ¼æ´ï¼šè¦æ±‚è¾“å…¥åˆ›å»ºæœåŠ¡å™¨å¯†ç 
        const serverName = prompt('è¯¥äº‘ç«¯è®¿é—®ç ä¸å­˜åœ¨ï¼Œæ˜¯å¦åˆ›å»ºæ–°çš„äº‘ç«¯æœåŠ¡å™¨ï¼Ÿè¯·è¾“å…¥æœåŠ¡å™¨åç§°ï¼š');
        if (serverName && serverName.trim()) {
            // å…ˆä¿å­˜è®¿é—®ç å’ŒæœåŠ¡å™¨åç§°
            localStorage.setItem('pendingCloudCode', cloudAccessCode);
            localStorage.setItem('pendingServerName', serverName.trim());
            
            // æ˜¾ç¤ºå¯†ç éªŒè¯æ¨¡æ€æ¡†
            document.getElementById('cloudCreatePasswordModal').style.display = 'flex';
            document.getElementById('cloudServerCreatePassword').value = '';
            document.getElementById('cloudPasswordError').style.display = 'none';
            document.getElementById('cloudServerCreatePassword').focus();
        }
    }
}

// ä¿®å¤ï¼šåˆ›å»ºæ–°äº‘ç«¯æœåŠ¡å™¨ï¼ˆéœ€è¦å¯†ç éªŒè¯ï¼‰
function createNewCloudServerAfterPassword(cloudCode, serverName) {
    const adminUsername = prompt('è®¾ç½®ç®¡ç†å‘˜ç”¨æˆ·åï¼š', 'admin');
    if (!adminUsername) return;
    
    const adminPassword = prompt('è®¾ç½®ç®¡ç†å‘˜å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰ï¼š', 'admin123');
    if (!adminPassword || adminPassword.length < 6) {
        alert('å¯†ç è‡³å°‘éœ€è¦6ä½');
        return;
    }
    
    const confirmPassword = prompt('ç¡®è®¤å¯†ç ï¼š', 'admin123');
    if (adminPassword !== confirmPassword) {
        alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
        return;
    }
    
    const serverKey = cloudCode;
    const adminId = 'user_' + Date.now();
    
    serverData = {
        info: {
            id: 'cloud_server_' + Date.now(),
            name: serverName,
            key: serverKey,
            type: 'cloud',
            cloudCode: cloudCode,
            createdAt: new Date().toISOString(),
            createdBy: adminUsername,
            creatorId: adminId,
            lastSync: new Date().toISOString()
        },
        users: [{
            id: adminId,
            username: adminUsername,
            password: adminPassword,
            rank: 99,
            isAdmin: true,
            lastLogin: null,
            createdAt: new Date().toISOString(),
            name: "ç®¡ç†å‘˜",
            deviceId: deviceId
        }],
        logs: [{
            action: 'cloud_server_created',
            user: adminUsername,
            timestamp: new Date().toISOString(),
            details: `äº‘ç«¯æœåŠ¡å™¨ "${serverName}" å·²åˆ›å»ºï¼Œè®¿é—®ç : ${cloudCode}`
        }],
        devices: [{
            id: deviceId,
            user: adminUsername,
            lastSeen: new Date().toISOString(),
            online: true
        }]
    };
    
    // ä¿å­˜åˆ°æœ¬åœ°
    localStorage.setItem(CLOUD_CONFIG.CLOUD_PREFIX + serverKey, JSON.stringify(serverData));
    localStorage.setItem('currentServerKey', serverKey);
    localStorage.setItem('currentUser', JSON.stringify({
        id: adminId,
        username: adminUsername,
        password: adminPassword
    }));
    
    currentUser = serverData.users[0];
    currentServer = {
        key: serverKey,
        name: serverName,
        type: 'cloud'
    };
    
    isCloudServer = true;
    cloudSyncEnabled = true;
    
    // å¯åŠ¨åŒæ­¥
    startCloudSync();
    
    // æ˜¾ç¤ºä¸»ç³»ç»Ÿ
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('mainContainer').style.display = 'block';
    
    showMainSystem();
    showNotification('äº‘ç«¯æœåŠ¡å™¨åˆ›å»ºæˆåŠŸï¼è®¿é—®ç : ' + cloudCode);
}

// ä¿®æ”¹å…³é—­æ¨¡æ€æ¡†å‡½æ•°ï¼Œæ”¯æŒæ–°çš„äº‘ç«¯å¯†ç æ¨¡æ€æ¡†
function closeModal() {
    document.getElementById('passwordModal').style.display = 'none';
    document.getElementById('deleteModal').style.display = 'none';
    document.getElementById('conflictModal').style.display = 'none';
    document.getElementById('cloudCreatePasswordModal').style.display = 'none';
    document.getElementById('overwriteCloudModal').style.display = 'none';
}

// ==================== ä»¥ä¸‹å‡½æ•°ä¿æŒåŸæœ‰é€»è¾‘ï¼Œæœªåšä¿®æ”¹ ====================

function loadServersList() {
    const select = document.getElementById('serverList');
    select.innerHTML = '<option value="">é€‰æ‹©æœåŠ¡å™¨</option>';
    
    // åŠ è½½æœ¬åœ°æœåŠ¡å™¨
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('server_') && !key.startsWith(CLOUD_CONFIG.CLOUD_PREFIX)) {
            try {
                const data = JSON.parse(localStorage.getItem(key));
                const option = document.createElement('option');
                option.value = key.replace('server_', '');
                option.textContent = `${data.info?.name || 'æœªçŸ¥æœåŠ¡å™¨'} (æœ¬åœ°)`;
                select.appendChild(option);
            } catch (e) {}
        }
    }
    
    // åŠ è½½äº‘ç«¯æœåŠ¡å™¨
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith(CLOUD_CONFIG.CLOUD_PREFIX)) {
            try {
                const data = JSON.parse(localStorage.getItem(key));
                const option = document.createElement('option');
                option.value = key.replace(CLOUD_CONFIG.CLOUD_PREFIX, '');
                option.textContent = `${data.info?.name || 'æœªçŸ¥æœåŠ¡å™¨'} (äº‘ç«¯)`;
                select.appendChild(option);
            } catch (e) {}
        }
    }
}

function connectServer() {
    if (!secretVerified) {
        alert('è¯·å…ˆé€šè¿‡æš—å·éªŒè¯');
        return;
    }
    
    const serverKey = document.getElementById('serverList').value;
    const errorDiv = document.getElementById('connectError');
    errorDiv.style.display = 'none';
    
    if (!serverKey) {
        errorDiv.textContent = 'è¯·é€‰æ‹©ä¸€ä¸ªæœåŠ¡å™¨';
        errorDiv.style.display = 'block';
        return;
    }
    
    // å°è¯•åŠ è½½æœ¬åœ°æœåŠ¡å™¨
    let serverDataStr = localStorage.getItem('server_' + serverKey);
    let serverType = 'local';
    
    // å¦‚æœä¸æ˜¯æœ¬åœ°æœåŠ¡å™¨ï¼Œå°è¯•äº‘ç«¯æœåŠ¡å™¨
    if (!serverDataStr) {
        serverDataStr = localStorage.getItem(CLOUD_CONFIG.CLOUD_PREFIX + serverKey);
        serverType = 'cloud';
    }
    
    if (!serverDataStr) {
        errorDiv.textContent = 'æœåŠ¡å™¨ä¸å­˜åœ¨æˆ–æ•°æ®å·²æŸå';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        serverData = JSON.parse(serverDataStr);
        currentServer = {
            key: serverKey,
            name: serverData.info.name,
            type: serverType
        };
        
        // è®¾ç½®äº‘ç«¯æ ‡å¿—
        isCloudServer = (serverType === 'cloud');
        
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => tab.classList.remove('active'));
        tabs[1].classList.add('active');
        
        document.getElementById('connectTab').style.display = 'none';
        document.getElementById('loginTab').style.display = 'block';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('loginError').style.display = 'none';
        
        // å¦‚æœæ˜¯äº‘ç«¯æœåŠ¡å™¨ï¼Œå¯åŠ¨åŒæ­¥
        if (isCloudServer) {
            cloudSyncEnabled = true;
            startCloudSync();
        }
        
    } catch (e) {
        errorDiv.textContent = 'æœåŠ¡å™¨æ•°æ®æ ¼å¼é”™è¯¯';
        errorDiv.style.display = 'block';
    }
}

function login() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const errorDiv = document.getElementById('loginError');
    errorDiv.style.display = 'none';
    
    if (!username || !password) {
        errorDiv.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (!currentServer || !serverData.users) {
        errorDiv.textContent = 'æœåŠ¡å™¨æ•°æ®é”™è¯¯';
        errorDiv.style.display = 'block';
        return;
    }
    
    const user = serverData.users.find(u => u.username === username && u.password === password);
    if (!user) {
        errorDiv.textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
        errorDiv.style.display = 'block';
        return;
    }
    
    user.lastLogin = new Date().toISOString();
    user.deviceId = deviceId;
    saveServerData();
    currentUser = user;
    
    localStorage.setItem('currentUser', JSON.stringify({
        id: user.id,
        username: user.username,
        password: user.password
    }));
    localStorage.setItem('currentServerKey', currentServer.key);
    
    // æ›´æ–°è®¾å¤‡åˆ—è¡¨
    updateDeviceStatus();
    
    addLog('user_login', username, `ç”¨æˆ· ${username} ç™»å½•ç³»ç»Ÿ`);
    showMainSystem();
}

function showMainSystem() {
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('mainContainer').style.display = 'block';
    
    document.getElementById('currentServerName').textContent = currentServer.name;
    document.getElementById('currentUserName').textContent = currentUser.name || currentUser.username;
    
    // æ›´æ–°æœåŠ¡å™¨ç±»å‹æ ‡è¯†
    const serverTypeBadge = document.getElementById('serverTypeBadge');
    if (isCloudServer) {
        serverTypeBadge.textContent = 'äº‘ç«¯';
        serverTypeBadge.style.background = '#722ed1';
    } else {
        serverTypeBadge.textContent = 'æœ¬åœ°';
        serverTypeBadge.style.background = '#1890ff';
    }
    
    // æ›´æ–°åŒæ­¥çŠ¶æ€
    updateSyncStatusDisplay();
    
    // å¦‚æœæ˜¯äº‘ç«¯æœåŠ¡å™¨ï¼Œæ˜¾ç¤ºåœ¨çº¿è®¾å¤‡
    if (isCloudServer) {
        document.getElementById('onlineDevicesSection').style.display = 'block';
        updateOnlineDevices();
    }
    
    updateDashboard();
}

// ==================== æ–°å¢ï¼šäº‘ç«¯åŒæ­¥åŠŸèƒ½ ====================

// ç”Ÿæˆè®¾å¤‡ID
function generateDeviceId() {
    const savedId = localStorage.getItem('military_device_id');
    if (savedId) return savedId;
    
    const newId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('military_device_id', newId);
    return newId;
}

// åˆå§‹åŒ–äº‘ç«¯çŠ¶æ€
function initCloudStatus() {
    updateCloudStatus(false, 'ç¦»çº¿');
}

// æ›´æ–°äº‘ç«¯çŠ¶æ€æ˜¾ç¤º
function updateCloudStatus(online, message) {
    const cloudStatus = document.getElementById('cloudStatus');
    const statusText = document.getElementById('cloudStatusText');
    const indicator = cloudStatus.querySelector('.sync-indicator');
    
    if (online) {
        cloudStatus.className = 'cloud-status cloud-online';
        indicator.className = 'sync-indicator sync-green';
        statusText.textContent = message;
    } else {
        cloudStatus.className = 'cloud-status cloud-offline';
        indicator.className = 'sync-indicator sync-red';
        statusText.textContent = message;
    }
}

// å¼€å§‹äº‘ç«¯åŒæ­¥
function startCloudSync() {
    if (!isCloudServer || !cloudSyncEnabled) return;
    
    // æ¸…é™¤æ—§çš„å®šæ—¶å™¨
    if (syncIntervalId) {
        clearInterval(syncIntervalId);
    }
    
    // ç«‹å³åŒæ­¥ä¸€æ¬¡
    syncWithCloud();
    
    // è®¾ç½®å®šæœŸåŒæ­¥
    syncIntervalId = setInterval(() => {
        if (cloudSyncEnabled) {
            syncWithCloud();
        }
    }, CLOUD_CONFIG.SYNC_INTERVAL);
    
    updateCloudStatus(true, 'äº‘ç«¯å·²è¿æ¥');
    showNotification('äº‘ç«¯åŒæ­¥å·²å¯åŠ¨');
}

// åŒæ­¥æ•°æ®åˆ°äº‘ç«¯ï¼ˆæ¨¡æ‹Ÿï¼‰
function syncWithCloud() {
    if (!currentServer || !isCloudServer) return;
    
    try {
        // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
        setTimeout(() => {
            // æ›´æ–°è®¾å¤‡çŠ¶æ€
            updateDeviceStatus();
            
            // ä¿å­˜å½“å‰æ•°æ®
            saveServerData();
            
            // æ›´æ–°åŒæ­¥çŠ¶æ€
            lastSyncTime = new Date();
            document.getElementById('lastSyncTime').textContent = lastSyncTime.toLocaleTimeString();
            document.getElementById('syncStatus').textContent = 'å·²åŒæ­¥';
            document.getElementById('syncStatusDetail').textContent = 'å·²åŒæ­¥';
            document.getElementById('syncStatusDetail').style.color = '#52c41a';
            
            // æ›´æ–°åœ¨çº¿è®¾å¤‡åˆ—è¡¨
            updateOnlineDevices();
            
            // éšæœºæ˜¾ç¤ºåŒæ­¥é€šçŸ¥ï¼ˆæ¨¡æ‹Ÿå…¶ä»–è®¾å¤‡çš„ä¿®æ”¹ï¼‰
            if (Math.random() > 0.7) {
                showRandomNotification();
            }
            
        }, 500);
        
    } catch (error) {
        console.error('åŒæ­¥å¤±è´¥:', error);
        updateCloudStatus(false, 'åŒæ­¥å¤±è´¥');
    }
}

// æ›´æ–°è®¾å¤‡çŠ¶æ€
function updateDeviceStatus() {
    if (!serverData.devices) {
        serverData.devices = [];
    }
    
    // æŸ¥æ‰¾æˆ–åˆ›å»ºå½“å‰è®¾å¤‡è®°å½•
    let device = serverData.devices.find(d => d.id === deviceId);
    if (!device) {
        device = {
            id: deviceId,
            user: currentUser.username,
            lastSeen: new Date().toISOString(),
            online: true
        };
        serverData.devices.push(device);
    } else {
        device.lastSeen = new Date().toISOString();
        device.online = true;
        device.user = currentUser.username;
    }
    
    // æ¸…ç†è¶…è¿‡5åˆ†é’Ÿæ²¡å“åº”çš„è®¾å¤‡
    const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
    serverData.devices = serverData.devices.filter(d => 
        d.lastSeen > fiveMinutesAgo || d.id === deviceId
    );
}

// æ›´æ–°åœ¨çº¿è®¾å¤‡æ˜¾ç¤º
function updateOnlineDevices() {
    if (!serverData.devices || !isCloudServer) return;
    
    const devicesList = document.getElementById('onlineDevicesList');
    const onlineDevices = serverData.devices.filter(d => d.online);
    const deviceCount = document.getElementById('deviceCount');
    
    deviceCount.textContent = onlineDevices.length;
    
    devicesList.innerHTML = onlineDevices.map(device => `
        <div style="padding:10px;border-bottom:1px solid #d9d9d9;display:flex;justify-content:space-between;align-items:center">
            <div>
                <strong>${device.user}</strong>
                <div style="font-size:12px;color:#666">${device.id === deviceId ? 'å½“å‰è®¾å¤‡' : 'å…¶ä»–è®¾å¤‡'}</div>
            </div>
            <div style="font-size:12px;color:#52c41a">
                â— åœ¨çº¿
                <div style="color:#999">${new Date(device.lastSeen).toLocaleTimeString()}</div>
            </div>
        </div>
    `).join('');
}

// æ˜¾ç¤ºéšæœºé€šçŸ¥ï¼ˆæ¨¡æ‹Ÿå…¶ä»–è®¾å¤‡çš„æ“ä½œï¼‰
function showRandomNotification() {
    const actions = [
        'æ–°å¢äº†äººå‘˜',
        'ä¿®æ”¹äº†å†›è¡”',
        'æ™‹å‡äº†äººå‘˜',
        'é‡ç½®äº†å¯†ç ',
        'åˆ é™¤äº†ç”¨æˆ·'
    ];
    
    const users = ['å¼ ä¸‰', 'æå››', 'ç‹äº”', 'èµµå…­', 'ç®¡ç†å‘˜'];
    const action = actions[Math.floor(Math.random() * actions.length)];
    const user = users[Math.floor(Math.random() * users.length)];
    
    showNotification(`${user} ${action}`);
}

// æ˜¾ç¤ºé€šçŸ¥
function showNotification(message) {
    const notification = document.getElementById('realtimeNotification');
    const messageDiv = document.getElementById('notificationMessage');
    
    messageDiv.textContent = message;
    notification.style.display = 'block';
    
    // 3ç§’åéšè—
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

// æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
function updateSyncStatusDisplay() {
    const syncStatus = document.getElementById('syncStatus');
    const syncStatusDetail = document.getElementById('syncStatusDetail');
    const syncServerType = document.getElementById('syncServerType');
    
    if (isCloudServer) {
        syncStatus.textContent = cloudSyncEnabled ? 'åŒæ­¥ä¸­' : 'å·²åœæ­¢';
        syncStatusDetail.textContent = cloudSyncEnabled ? 'äº‘ç«¯åŒæ­¥å·²å¯ç”¨' : 'äº‘ç«¯åŒæ­¥å·²ç¦ç”¨';
        syncStatusDetail.style.color = cloudSyncEnabled ? '#52c41a' : '#ff4d4f';
        syncServerType.textContent = 'äº‘ç«¯æœåŠ¡å™¨';
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.getElementById('enableSyncBtn').style.display = cloudSyncEnabled ? 'none' : 'block';
        document.getElementById('disableSyncBtn').style.display = cloudSyncEnabled ? 'block' : 'none';
    } else {
        syncStatus.textContent = 'æœ¬åœ°æ¨¡å¼';
        syncStatusDetail.textContent = 'æœ¬åœ°æœåŠ¡å™¨ï¼Œä¸æ”¯æŒå¤šè®¾å¤‡åŒæ­¥';
        syncStatusDetail.style.color = '#999';
        syncServerType.textContent = 'æœ¬åœ°æœåŠ¡å™¨';
    }
}

// ç«‹å³åŒæ­¥
function syncNow() {
    if (!isCloudServer) {
        showNotification('æœ¬åœ°æœåŠ¡å™¨æ— éœ€åŒæ­¥');
        return;
    }
    
    showNotification('æ­£åœ¨åŒæ­¥æ•°æ®...');
    syncWithCloud();
}

// å¼ºåˆ¶åŒæ­¥
function forceSync() {
    if (!isCloudServer) {
        showNotification('ä»…äº‘ç«¯æœåŠ¡å™¨æ”¯æŒåŒæ­¥');
        return;
    }
    
    showNotification('å¼ºåˆ¶åŒæ­¥ä¸­...');
    updateDeviceStatus();
    saveServerData();
    
    // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚
    setTimeout(() => {
        showNotification('åŒæ­¥å®Œæˆ');
        updateDashboard();
    }, 1000);
}

// å¯ç”¨äº‘ç«¯åŒæ­¥
function enableCloudSync() {
    if (!isCloudServer) {
        alert('ä»…äº‘ç«¯æœåŠ¡å™¨æ”¯æŒåŒæ­¥åŠŸèƒ½');
        return;
    }
    
    cloudSyncEnabled = true;
    startCloudSync();
    updateSyncStatusDisplay();
    showNotification('äº‘ç«¯åŒæ­¥å·²å¯ç”¨');
}

// ç¦ç”¨äº‘ç«¯åŒæ­¥
function disableCloudSync() {
    if (!isCloudServer) return;
    
    cloudSyncEnabled = false;
    if (syncIntervalId) {
        clearInterval(syncIntervalId);
        syncIntervalId = null;
    }
    updateSyncStatusDisplay();
    showNotification('äº‘ç«¯åŒæ­¥å·²ç¦ç”¨');
}

// æ•°æ®è¿ç§»ï¼šæœ¬åœ° â†’ äº‘ç«¯
function migrateToCloud() {
    if (isCloudServer) {
        alert('å½“å‰å·²ç»æ˜¯äº‘ç«¯æœåŠ¡å™¨');
        return;
    }
    
    const cloudCode = prompt('è¯·è¾“å…¥äº‘ç«¯è®¿é—®ç ï¼ˆç”¨äºå…¶ä»–è®¾å¤‡è¿æ¥ï¼‰ï¼š', 'military_' + Date.now());
    if (!cloudCode || !/^[a-zA-Z0-9_]+$/.test(cloudCode)) {
        alert('è®¿é—®ç åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿');
        return;
    }
    
    // æ£€æŸ¥è®¿é—®ç æ˜¯å¦å·²å­˜åœ¨
    const existingCloudData = localStorage.getItem(CLOUD_CONFIG.CLOUD_PREFIX + cloudCode);
    if (existingCloudData) {
        if (!confirm(`äº‘ç«¯è®¿é—®ç  "${cloudCode}" å·²å­˜åœ¨æœåŠ¡å™¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ\n\nâš ï¸ è­¦å‘Šï¼šè¦†ç›–å°†åˆ é™¤åŸæœ‰æœåŠ¡å™¨åŠå…¶æ‰€æœ‰æ•°æ®ï¼`)) {
            return;
        }
    }
    
    if (confirm('å°†æœ¬åœ°æ•°æ®è¿ç§»åˆ°äº‘ç«¯åï¼Œå…¶ä»–è®¾å¤‡å¯ä»¥ä½¿ç”¨è®¿é—®ç è¿æ¥ã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ')) {
        // è½¬æ¢ä¸ºäº‘ç«¯æœåŠ¡å™¨
        serverData.info.type = 'cloud';
        serverData.info.cloudCode = cloudCode;
        
        // ä¿å­˜ä¸ºäº‘ç«¯æœåŠ¡å™¨
        localStorage.setItem(CLOUD_CONFIG.CLOUD_PREFIX + cloudCode, JSON.stringify(serverData));
        
        // åˆ é™¤æ—§çš„æœ¬åœ°æœåŠ¡å™¨
        localStorage.removeItem('server_' + currentServer.key);
        
        // æ›´æ–°å½“å‰æœåŠ¡å™¨
        currentServer.key = cloudCode;
        currentServer.type = 'cloud';
        isCloudServer = true;
        
        // æ›´æ–°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('currentServerKey', cloudCode);
        
        // å¯åŠ¨äº‘ç«¯åŒæ­¥
        cloudSyncEnabled = true;
        startCloudSync();
        
        // åˆ·æ–°æ˜¾ç¤º
        showMainSystem();
        showNotification('æ•°æ®å·²è¿ç§»åˆ°äº‘ç«¯ï¼Œè®¿é—®ç : ' + cloudCode);
    }
}

// æ•°æ®è¿ç§»ï¼šäº‘ç«¯ â†’ æœ¬åœ°
function migrateFromCloud() {
    if (!isCloudServer) {
        alert('å½“å‰å·²ç»æ˜¯æœ¬åœ°æœåŠ¡å™¨');
        return;
    }
    
    if (confirm('å°†äº‘ç«¯æ•°æ®è¿ç§»åˆ°æœ¬åœ°åï¼Œå°†æ— æ³•å¤šè®¾å¤‡åŒæ­¥ã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ')) {
        // è½¬æ¢ä¸ºæœ¬åœ°æœåŠ¡å™¨
        serverData.info.type = 'local';
        delete serverData.info.cloudCode;
        
        // ç”Ÿæˆæ–°çš„æœ¬åœ°æœåŠ¡å™¨key
        const newKey = 'key_' + Date.now() + '_' + Math.random().toString(36).substr(2, 8);
        
        // ä¿å­˜ä¸ºæœ¬åœ°æœåŠ¡å™¨
        localStorage.setItem('server_' + newKey, JSON.stringify(serverData));
        
        // åˆ é™¤äº‘ç«¯æœåŠ¡å™¨
        localStorage.removeItem(CLOUD_CONFIG.CLOUD_PREFIX + currentServer.key);
        
        // æ›´æ–°å½“å‰æœåŠ¡å™¨
        currentServer.key = newKey;
        currentServer.type = 'local';
        isCloudServer = false;
        
        // æ›´æ–°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('currentServerKey', newKey);
        
        // åœæ­¢äº‘ç«¯åŒæ­¥
        cloudSyncEnabled = false;
        if (syncIntervalId) {
            clearInterval(syncIntervalId);
            syncIntervalId = null;
        }
        
        // åˆ·æ–°æ˜¾ç¤º
        showMainSystem();
        showNotification('æ•°æ®å·²è¿ç§»åˆ°æœ¬åœ°');
    }
}

// ==================== ä¿®å¤é€€å‡ºåŠŸèƒ½ ====================

function logout() {
    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        // æ›´æ–°è®¾å¤‡çŠ¶æ€ä¸ºç¦»çº¿
        if (deviceId && serverData.devices) {
            const device = serverData.devices.find(d => d.id === deviceId);
            if (device) {
                device.online = false;
                saveServerData();
            }
        }
        
        addLog('user_logout', currentUser.username, `ç”¨æˆ· ${currentUser.username} é€€å‡ºç³»ç»Ÿ`);
        
        currentUser = null;
        currentServer = null;
        serverData = { info: null, users: [], logs: [] };
        
        // åœæ­¢åŒæ­¥
        if (syncIntervalId) {
            clearInterval(syncIntervalId);
            syncIntervalId = null;
        }
        
        // æ¸…é™¤ç”¨æˆ·ç™»å½•çŠ¶æ€ï¼Œä½†ä¿ç•™æš—å·éªŒè¯çŠ¶æ€
        localStorage.removeItem('currentUser');
        localStorage.removeItem('currentServerKey');
        
        // æ˜¾ç¤ºç™»å½•é¡µé¢è€Œä¸æ˜¯éªŒè¯é¡µé¢
        document.getElementById('mainContainer').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'block';
        document.getElementById('connectTab').style.display = 'block';
        document.getElementById('loginTab').style.display = 'none';
        
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach((tab, index) => {
            tab.classList.remove('active');
            if (index === 0) tab.classList.add('active');
        });
        
        loadServersList();
        updateCloudStatus(false, 'ç¦»çº¿');
    }
}

// ==================== ä¿®å¤ç¼ºå¤±çš„å…³é”®å‡½æ•° ====================

// å…³é—­åˆ›å»ºæœåŠ¡å™¨è¡¨å•
function closeCreateServerForm() {
    document.getElementById('createServerForm').style.display = 'none';
}

// æ ‡ç­¾é¡µåˆ‡æ¢å‡½æ•°ï¼ˆä¿®å¤ï¼‰
function showTab(event, tabName) {
    if (!secretVerified) {
        alert('è¯·å…ˆé€šè¿‡æš—å·éªŒè¯');
        return;
    }
    
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
        tab.classList.remove('active');
    });
    
    event.target.classList.add('active');
    
    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(content => {
        content.style.display = 'none';
    });
    
    document.getElementById(tabName + 'Tab').style.display = 'block';
}

// ä¸»æ ‡ç­¾é¡µåˆ‡æ¢å‡½æ•°ï¼ˆä¿®å¤ï¼‰
function showMainTab(event, tabName) {
    if (!secretVerified) {
        alert('è¯·å…ˆé€šè¿‡æš—å·éªŒè¯');
        return;
    }
    
    const mainTabs = document.querySelectorAll('.main-tab');
    mainTabs.forEach(tab => {
        tab.style.display = 'none';
    });
    
    const tabs = document.querySelectorAll('.main-container .tab');
    tabs.forEach(tab => {
        tab.classList.remove('active');
    });
    
    event.target.classList.add('active');
    
    document.getElementById(tabName + 'Tab').style.display = 'block';
    
    if (tabName === 'personnel') {
        loadPersonnelList();
    } else if (tabName === 'promotion') {
        loadPromoteList();
    } else if (tabName === 'users') {
        loadUsersList();
    } else if (tabName === 'serverSettings') {
        updateServerSettings();
    } else if (tabName === 'cloudSync') {
        updateSyncStatusDisplay();
        if (isCloudServer) {
            updateOnlineDevices();
        }
    }
}

// äººå‘˜åˆ—è¡¨åŠ è½½
function loadPersonnelList() {
    if (!currentUser) return;
    
    const personnelList = document.getElementById('personnelList');
    personnelList.innerHTML = '';
    
    serverData.users.forEach(user => {
        if (user.rank < currentUser.rank && user.id !== currentUser.id) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.name || user.username}</td>
                <td><span style="color:${getRankColor(user.rank)};font-weight:bold">${getRankName(user.rank)}</span></td>
                <td>${user.isAdmin ? '<span style="color:#52c41a">ç®¡ç†å‘˜</span>' : '<span style="color:#1890ff">æ™®é€šç”¨æˆ·</span>'}</td>
                <td>${new Date(user.createdAt).toLocaleDateString('zh-CN')}</td>
                <td>
                    <button class="action-btn action-btn-primary" onclick="viewUserDetails('${user.id}')">æŸ¥çœ‹</button>
                </td>
            `;
            personnelList.appendChild(row);
        }
    });
    
    if (personnelList.children.length === 0) {
        personnelList.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#999;padding:30px">æ²¡æœ‰å¯ç®¡ç†çš„äººå‘˜</td></tr>`;
    }
}

// æ™‹å‡åˆ—è¡¨åŠ è½½
function loadPromoteList() {
    const promoteSelect = document.getElementById('promotePerson');
    promoteSelect.innerHTML = '<option value="">è¯·é€‰æ‹©äººå‘˜</option>';
    
    serverData.users.forEach(user => {
        if (user.rank < currentUser.rank && user.id !== currentUser.id && !user.isAdmin) {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = `${user.name || user.username} (${getRankName(user.rank)})`;
            promoteSelect.appendChild(option);
        }
    });
    
    // ç›‘å¬é€‰æ‹©å˜åŒ–
    promoteSelect.onchange = function() {
        const userId = this.value;
        const user = serverData.users.find(u => u.id === userId);
        const infoDiv = document.getElementById('promoteInfo');
        
        if (user) {
            infoDiv.style.display = 'block';
            document.getElementById('currentRankText').textContent = getRankName(user.rank);
            
            const action = document.getElementById('promoteAction').value;
            let newRank = user.rank;
            if (action === 'up' && user.rank < 5) {
                newRank = user.rank + 1;
            } else if (action === 'down' && user.rank > 0) {
                newRank = user.rank - 1;
            }
            document.getElementById('newRankText').textContent = getRankName(newRank);
        } else {
            infoDiv.style.display = 'none';
        }
    };
    
    // ç›‘å¬æ“ä½œç±»å‹å˜åŒ–
    document.getElementById('promoteAction').onchange = function() {
        const userId = document.getElementById('promotePerson').value;
        if (userId) {
            const user = serverData.users.find(u => u.id === userId);
            if (user) {
                let newRank = user.rank;
                const action = this.value;
                if (action === 'up' && user.rank < 5) {
                    newRank = user.rank + 1;
                } else if (action === 'down' && user.rank > 0) {
                    newRank = user.rank - 1;
                }
                document.getElementById('newRankText').textContent = getRankName(newRank);
            }
        }
    };
}

// æ™‹å‡äººå‘˜å‡½æ•°
function promotePerson() {
    const userId = document.getElementById('promotePerson').value;
    const action = document.getElementById('promoteAction').value;
    const errorDiv = document.getElementById('promoteError');
    errorDiv.style.display = 'none';
    
    if (!userId) {
        errorDiv.textContent = 'è¯·é€‰æ‹©è¦æ“ä½œçš„äººå‘˜';
        errorDiv.style.display = 'block';
        return;
    }
    
    const user = serverData.users.find(u => u.id === userId);
    if (!user) {
        errorDiv.textContent = 'äººå‘˜ä¸å­˜åœ¨';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (user.isAdmin) {
        errorDiv.textContent = 'ä¸èƒ½æ“ä½œç®¡ç†å‘˜';
        errorDiv.style.display = 'block';
        return;
    }
    
    let newRank = user.rank;
    if (action === 'up') {
        if (user.rank >= 5) {
            errorDiv.textContent = 'å·²ç»æ˜¯æœ€é«˜å†›è¡”';
            errorDiv.style.display = 'block';
            return;
        }
        newRank = user.rank + 1;
    } else if (action === 'down') {
        if (user.rank <= 0) {
            errorDiv.textContent = 'å·²ç»æ˜¯æœ€ä½å†›è¡”';
            errorDiv.style.display = 'block';
            return;
        }
        newRank = user.rank - 1;
    }
    
    const oldRankName = getRankName(user.rank);
    const newRankName = getRankName(newRank);
    user.rank = newRank;
    
    addLog('promote', currentUser.username, `${action === 'up' ? 'æ™‹å‡' : 'é™çº§'} ${user.name || user.username} ä» ${oldRankName} åˆ° ${newRankName}`);
    saveServerData();
    
    alert(`${action === 'up' ? 'æ™‹å‡' : 'é™çº§'}æˆåŠŸï¼${user.name || user.username} ä» ${oldRankName} å˜ä¸º ${newRankName}`);
    
    // é‡ç½®è¡¨å•
    document.getElementById('promotePerson').value = '';
    document.getElementById('promoteInfo').style.display = 'none';
    loadPromoteList();
}

// æ·»åŠ æ–°äººå‘˜
function addNewPerson() {
    const name = document.getElementById('newName').value.trim();
    const password = document.getElementById('newPassword').value.trim();
    const rank = parseInt(document.getElementById('newRank').value);
    const errorDiv = document.getElementById('addError');
    errorDiv.style.display = 'none';
    
    if (!name) {
        errorDiv.textContent = 'è¯·è¾“å…¥äººå‘˜å§“å';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (!password) {
        errorDiv.textContent = 'è¯·è®¾ç½®åˆå§‹å¯†ç ';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (password.length < 3) {
        errorDiv.textContent = 'å¯†ç è‡³å°‘éœ€è¦3ä½';
        errorDiv.style.display = 'block';
        return;
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    if (serverData.users.some(u => u.name === name)) {
        errorDiv.textContent = 'è¯¥å§“åå·²å­˜åœ¨';
        errorDiv.style.display = 'block';
        return;
    }
    
    const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 8);
    const username = 'user' + Date.now();
    
    const newUser = {
        id: userId,
        username: username,
        password: password,
        name: name,
        rank: rank,
        isAdmin: false,
        createdAt: new Date().toISOString(),
        lastLogin: null,
        deviceId: null
    };
    
    serverData.users.push(newUser);
    addLog('add_person', currentUser.username, `æ·»åŠ æ–°äººå‘˜: ${name}ï¼Œåˆå§‹å†›è¡”: ${getRankName(rank)}`);
    saveServerData();
    
    alert(`æ·»åŠ æˆåŠŸï¼\nå§“å: ${name}\nç”¨æˆ·å: ${username}\nå¯†ç : ${password}\nå†›è¡”: ${getRankName(rank)}`);
    
    // é‡ç½®è¡¨å•
    document.getElementById('newName').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('newRank').value = '0';
    updateDashboard();
}

// ç”¨æˆ·åˆ—è¡¨åŠ è½½
function loadUsersList() {
    const usersList = document.getElementById('usersList');
    usersList.innerHTML = '';
    
    serverData.users.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${user.username}</td>
            <td><span style="color:${getRankColor(user.rank)};font-weight:bold">${getRankName(user.rank)}</span></td>
            <td>${user.lastLogin ? new Date(user.lastLogin).toLocaleString('zh-CN') : 'ä»æœªç™»å½•'}</td>
            <td>${user.isAdmin ? '<span style="color:#52c41a;font-weight:bold">ç®¡ç†å‘˜</span>' : 
                user.lastLogin ? '<span style="color:#1890ff">åœ¨çº¿</span>' : '<span style="color:#999">ç¦»çº¿</span>'}</td>
            <td>
                ${user.id !== currentUser.id ? 
                    `<button class="action-btn action-btn-danger" onclick="resetUserPassword('${user.id}')">é‡ç½®å¯†ç </button>
                     ${!user.isAdmin && currentUser.isAdmin ? 
                        `<button class="action-btn action-btn-primary" onclick="deleteUser('${user.id}')">åˆ é™¤</button>` : ''}`
                    : '<span style="color:#666">å½“å‰ç”¨æˆ·</span>'}
            </td>
        `;
        usersList.appendChild(row);
    });
}

// æ›´æ–°ä»ªè¡¨æ¿
function updateDashboard() {
    if (!currentServer || !serverData.users) return;
    
    document.getElementById('totalUsers').textContent = serverData.users.length;
    document.getElementById('activeUsers').textContent = serverData.users.filter(u => u.lastLogin && !u.isAdmin).length;
    document.getElementById('adminCount').textContent = serverData.users.filter(u => u.isAdmin).length;
    
    // æ›´æ–°æœ€è¿‘æ“ä½œ
    const recentActions = document.getElementById('recentActions');
    if (serverData.logs && serverData.logs.length > 0) {
        const recentLogs = serverData.logs.slice(-5).reverse();
        recentActions.innerHTML = recentLogs.map(log => `
            <div style="padding:10px;border-bottom:1px solid #f0f0f0">
                <div style="font-size:12px;color:#666">${new Date(log.timestamp).toLocaleString('zh-CN')}</div>
                <div>${log.details}</div>
                <div style="font-size:12px;color:#999">æ“ä½œäºº: ${log.user}</div>
            </div>
        `).join('');
    }
}

// æ£€æŸ¥è‡ªåŠ¨ç™»å½•ï¼ˆç®€åŒ–ç‰ˆï¼‰
function checkAutoLogin() {
    // ç®€åŒ–çš„è‡ªåŠ¨ç™»å½•æ£€æŸ¥
    const savedUser = localStorage.getItem('currentUser');
    const savedServerKey = localStorage.getItem('currentServerKey');
    
    if (savedUser && savedServerKey) {
        try {
            const userData = JSON.parse(savedUser);
            const serverDataStr = localStorage.getItem('server_' + savedServerKey) || 
                                 localStorage.getItem(CLOUD_CONFIG.CLOUD_PREFIX + savedServerKey);
            
            if (serverDataStr) {
                serverData = JSON.parse(serverDataStr);
                const user = serverData.users.find(u => u.id === userData.id && u.password === userData.password);
                
                if (user) {
                    currentUser = user;
                    currentServer = {
                        key: savedServerKey,
                        name: serverData.info.name,
                        type: serverData.info.type || 'local'
                    };
                    isCloudServer = (serverData.info.type === 'cloud');
                    
                    if (isCloudServer) {
                        cloudSyncEnabled = true;
                        startCloudSync();
                    }
                    
                    showMainSystem();
                    return;
                }
            }
        } catch (e) {
            console.log('è‡ªåŠ¨ç™»å½•å¤±è´¥:', e);
        }
    }
}

// ç®€åŒ–å…¶ä»–ç¼ºå¤±å‡½æ•°
function viewUserDetails(userId) {
    const user = serverData.users.find(u => u.id === userId);
    if (user) {
        alert(`ç”¨æˆ·è¯¦æƒ…:\nå§“å: ${user.name || user.username}\nç”¨æˆ·å: ${user.username}\nå†›è¡”: ${getRankName(user.rank)}\nåˆ›å»ºæ—¶é—´: ${new Date(user.createdAt).toLocaleString('zh-CN')}\næœ€åç™»å½•: ${user.lastLogin ? new Date(user.lastLogin).toLocaleString('zh-CN') : 'ä»æœªç™»å½•'}`);
    }
}

function resetUserPassword(userId) {
    const user = serverData.users.find(u => u.id === userId);
    if (user && confirm(`ç¡®å®šè¦é‡ç½® ${user.name || user.username} çš„å¯†ç å—ï¼Ÿ`)) {
        const newPassword = prompt('è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘3ä½ï¼‰ï¼š', '123456');
        if (newPassword && newPassword.length >= 3) {
            user.password = newPassword;
            saveServerData();
            addLog('reset_password', currentUser.username, `é‡ç½® ${user.name || user.username} çš„å¯†ç `);
            alert('å¯†ç é‡ç½®æˆåŠŸï¼æ–°å¯†ç : ' + newPassword);
            loadUsersList();
        }
    }
}

function deleteUser(userId) {
    const user = serverData.users.find(u => u.id === userId);
    if (user && !user.isAdmin && confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${user.name || user.username} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
        serverData.users = serverData.users.filter(u => u.id !== userId);
        saveServerData();
        addLog('delete_user', currentUser.username, `åˆ é™¤ç”¨æˆ· ${user.name || user.username}`);
        alert('ç”¨æˆ·åˆ é™¤æˆåŠŸï¼');
        loadUsersList();
        loadPersonnelList();
        loadPromoteList();
        updateDashboard();
    }
}

function showDeleteModal() {
    if (!currentServer || !serverData.info) return;
    
    const user = serverData.users.find(u => u.id === currentUser.id);
    if (!user || user.id !== serverData.info.creatorId) {
        alert('åªæœ‰æœåŠ¡å™¨åˆ›å»ºè€…å¯ä»¥åˆ é™¤æœåŠ¡å™¨');
        return;
    }
    
    document.getElementById('deleteServerName').textContent = serverData.info.name;
    document.getElementById('deleteConfirmPassword').value = '';
    document.getElementById('deleteModal').style.display = 'flex';
}

function confirmDeleteServer() {
    const password = document.getElementById('deleteConfirmPassword').value;
    const user = serverData.users.find(u => u.id === currentUser.id);
    
    if (!user || user.password !== password) {
        alert('å¯†ç é”™è¯¯');
        return;
    }
    
    if (confirm('âš ï¸ æœ€åç¡®è®¤ï¼åˆ é™¤æœåŠ¡å™¨å°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰æ•°æ®ï¼ç¡®å®šç»§ç»­å—ï¼Ÿ')) {
        if (isCloudServer) {
            localStorage.removeItem(CLOUD_CONFIG.CLOUD_PREFIX + currentServer.key);
        } else {
            localStorage.removeItem('server_' + currentServer.key);
        }
        
        localStorage.removeItem('currentUser');
        localStorage.removeItem('currentServerKey');
        
        alert('æœåŠ¡å™¨åˆ é™¤æˆåŠŸï¼');
        
        currentUser = null;
        currentServer = null;
        serverData = { info: null, users: [], logs: [] };
        isCloudServer = false;
        cloudSyncEnabled = false;
        
        if (syncIntervalId) {
            clearInterval(syncIntervalId);
            syncIntervalId = null;
        }
        
        document.getElementById('mainContainer').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'block';
        closeModal();
        
        document.getElementById('secretCode').value = '';
        document.getElementById('secretCode').focus();
    }
}

// å†²çªè§£å†³å‡½æ•°ï¼ˆç®€åŒ–ï¼‰
function resolveConflict(choice) {
    document.getElementById('conflictModal').style.display = 'none';
    showNotification(`ä½¿ç”¨${choice === 'local' ? 'æœ¬åœ°' : choice === 'cloud' ? 'äº‘ç«¯' : 'åˆå¹¶'}æ•°æ®`);
}

// ==================== ä¿®æ”¹ä¿å­˜æœåŠ¡å™¨æ•°æ®å‡½æ•° ====================

// ä¿®æ”¹ä¿å­˜æœåŠ¡å™¨æ•°æ®å‡½æ•°
function saveServerData() {
    if (!currentServer || !currentServer.key) return;
    
    // æ›´æ–°æœ€ååŒæ­¥æ—¶é—´
    if (serverData.info) {
        serverData.info.lastSync = new Date().toISOString();
    }
    
    // æ ¹æ®æœåŠ¡å™¨ç±»å‹ä¿å­˜
    if (isCloudServer) {
        localStorage.setItem(CLOUD_CONFIG.CLOUD_PREFIX + currentServer.key, JSON.stringify(serverData));
    } else {
        localStorage.setItem('server_' + currentServer.key, JSON.stringify(serverData));
    }
}

// ==================== ä¿æŒåŸæœ‰çš„è¾…åŠ©å‡½æ•° ====================
function getRankName(rankId) {
    const rank = ranks.find(r => r.id === rankId);
    return rank ? rank.name : 'æœªçŸ¥';
}

function getRankColor(rankId) {
    const rank = ranks.find(r => r.id === rankId);
    return rank ? rank.color : '#8c8c8c';
}

function addLog(action, user, details) {
    const log = {
        action: action,
        user: user,
        timestamp: new Date().toISOString(),
        details: details
    };
    
    serverData.logs.push(log);
    if (serverData.logs.length > 100) {
        serverData.logs = serverData.logs.slice(-100);
    }
    
    saveServerData();
    
    if (document.getElementById('dashboardTab').style.display !== 'none') {
        updateDashboard();
    }
}

// ==================== åŸæœ‰çš„é”å®šç³»ç»Ÿå‡½æ•° ====================
function checkLockStatus() {
    const now = Date.now();
    const lockData = localStorage.getItem('system_lock');
    
    if (lockData) {
        const lockInfo = JSON.parse(lockData);
        lockUntil = lockInfo.lockUntil;
        
        if (now < lockUntil) {
            showLockScreen(lockUntil - now);
            return false;
        } else {
            localStorage.removeItem('system_lock');
            localStorage.removeItem('failed_attempts');
            failedAttempts = 0;
            updateAttemptsDisplay();
            hideLockScreen();
            return true;
        }
    }
    
    hideLockScreen();
    return true;
}

function showLockScreen(remainingTime) {
    const lockScreen = document.getElementById('lockScreen');
    const lockTimeSpan = document.getElementById('lockTime');
    
    lockScreen.style.display = 'flex';
    document.getElementById('authContainer').style.display = 'none';
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('mainContainer').style.display = 'none';
    
    function updateCountdown() {
        const now = Date.now();
        const timeLeft = lockUntil - now;
        
        if (timeLeft <= 0) {
            hideLockScreen();
            return;
        }
        
        const minutes = Math.floor(timeLeft / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);
        lockTimeSpan.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        setTimeout(updateCountdown, 1000);
    }
    
    updateCountdown();
}

function hideLockScreen() {
    document.getElementById('lockScreen').style.display = 'none';
    document.getElementById('authContainer').style.display = 'block';
    setTimeout(() => {
        document.getElementById('secretCode').focus();
    }, 100);
}

function loadAttempts() {
    const attemptsData = localStorage.getItem('failed_attempts');
    failedAttempts = attemptsData ? parseInt(attemptsData) || 0 : 0;
    updateAttemptsDisplay();
}

function saveAttempts() {
    localStorage.setItem('failed_attempts', failedAttempts.toString());
}

function lockSystem() {
    lockUntil = Date.now() + LOCK_TIME;
    localStorage.setItem('system_lock', JSON.stringify({
        lockUntil: lockUntil,
        lockedAt: new Date().toISOString()
    }));
    showLockScreen(LOCK_TIME);
}

function updateAttemptsDisplay() {
    const attemptsLeft = MAX_ATTEMPTS - failedAttempts;
    document.getElementById('attemptsLeft').textContent = attemptsLeft;
    
    if (attemptsLeft <= 1) {
        document.getElementById('attemptsLeft').style.color = '#d32f2f';
        document.getElementById('attemptsLeft').style.fontWeight = 'bold';
    } else if (attemptsLeft <= 2) {
        document.getElementById('attemptsLeft').style.color = '#f57c00';
    } else {
        document.getElementById('attemptsLeft').style.color = '#666';
    }
}

</script>
</body>
</html>