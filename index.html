<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>å†›äº‹èŒä½ç®¡ç†ç³»ç»Ÿ - äº‘ç«¯å¤šè®¾å¤‡ç‰ˆ</title>
<style>
/* ä¿æŒæ‰€æœ‰åŸæœ‰CSSä¸å˜ */
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
body{background:linear-gradient(135deg,#1a237e 0%,#283593 100%);min-height:100vh;padding:20px;display:flex;justify-content:center;align-items:center}
#authContainer{max-width:400px;background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.3);overflow:hidden}
.auth-header{background:linear-gradient(to right,#d32f2f,#b71c1c);color:white;padding:30px;text-align:center}
.auth-body{padding:40px 30px}
.auth-title{font-size:24px;color:#333;text-align:center;margin-bottom:10px;font-weight:bold}
.auth-subtitle{color:#666;text-align:center;margin-bottom:30px;font-size:14px}
.secret-input{position:relative;margin-bottom:25px}
.secret-input input{width:100%;padding:15px 20px;padding-left:50px;border:2px solid #ddd;border-radius:10px;font-size:16px;background:#f9f9f9}
.secret-input input:focus{border-color:#d32f2f;background:white;outline:none;box-shadow:0 0 0 3px rgba(211,47,47,0.1)}
.secret-icon{position:absolute;left:15px;top:50%;transform:translateY(-50%);color:#d32f2f;font-size:20px}
.auth-button{width:100%;padding:16px;background:linear-gradient(to right,#d32f2f,#b71c1c);color:white;border:none;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;margin-bottom:20px;transition:all 0.3s}
.auth-button:hover{background:linear-gradient(to right,#c62828,#a10f0f);transform:translateY(-2px);box-shadow:0 5px 15px rgba(211,47,47,0.3)}
.auth-note{background:#f8f9fa;padding:15px;border-radius:8px;border-left:4px solid #d32f2f;font-size:13px;color:#666;line-height:1.5}
.auth-error{color:#d32f2f;margin-top:10px;padding:10px;background:#ffebee;border-radius:5px;border:1px solid #ffcdd2;text-align:center;display:none}
.auth-success{color:#2e7d32;margin-top:10px;padding:10px;background:#e8f5e9;border-radius:5px;border:1px solid #c8e6c9;text-align:center;display:none}
.countdown{text-align:center;color:#666;font-size:12px;margin-top:15px}
.container{display:none;max-width:500px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);overflow:hidden}
.header{background:#1890ff;color:white;padding:20px;text-align:center}
.body{padding:30px}
.form-group{margin-bottom:20px}
label{display:block;margin-bottom:8px;color:#333;font-weight:bold}
input,select{width:100%;padding:12px;border:1px solid #ddd;border-radius:5px;font-size:16px}
input:focus,select:focus{border-color:#1890ff;outline:none;box-shadow:0 0 0 2px rgba(24,144,255,0.2)}
.btn{width:100%;padding:14px;background:#1890ff;color:white;border:none;border-radius:5px;font-size:16px;font-weight:bold;cursor:pointer;transition:background 0.3s}
.btn:hover{background:#096dd9}
.btn-success{background:#52c41a}
.btn-success:hover{background:#389e0d}
.btn-danger{background:#ff4d4f}
.btn-danger:hover{background:#d9363e}
.error{color:#ff4d4f;margin-top:10px;padding:10px;background:#fff2f0;border:1px solid #ffccc7;border-radius:5px;display:none}
.main-container{display:none;max-width:1200px;margin:0 auto}
.main-header{background:white;padding:15px 20px;margin-bottom:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:center}
.tabs{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
.tab{padding:12px 24px;background:white;border:1px solid #ddd;border-radius:5px;cursor:pointer;font-weight:bold;transition:all 0.3s}
.tab:hover{background:#f5f5f5}
.tab.active{background:#1890ff;color:white;border-color:#1890ff}
.content{background:white;padding:25px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);min-height:400px}
table{width:100%;border-collapse:collapse;margin-top:20px}
th{background:#fafafa;padding:12px;text-align:left;border-bottom:1px solid #ddd;font-weight:bold}
td{padding:12px;border-bottom:1px solid #f0f0f0}
tr:hover{background:#fafafa}
.badge{padding:4px 8px;border-radius:4px;font-size:12px;font-weight:bold;color:white;display:inline-block}
.action-btn{padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-size:14px;margin-right:5px}
.action-btn-primary{background:#1890ff;color:white}
.action-btn-danger{background:#ff4d4f;color:white}
.action-btn-success{background:#52c41a;color:white}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:20px;margin-bottom:30px}
.stat-card{background:white;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);text-align:center}
.stat-card .number{font-size:32px;font-weight:bold;color:#1890ff;margin-bottom:10px}
.stat-card .label{color:#666;font-size:14px}
.locked-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);display:flex;justify-content:center;align-items:center;z-index:9999;flex-direction:column;color:white;text-align:center;padding:20px}
.lock-icon{font-size:80px;margin-bottom:20px;color:#d32f2f}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:10000;justify-content:center;align-items:center}
.modal-content{background:white;padding:30px;border-radius:10px;width:90%;max-width:400px}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-title{font-size:20px;font-weight:bold}
.tab-content{display:none}
.cloud-status {
    position: fixed;
    top: 10px;
    right: 10px;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    z-index: 10001;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.cloud-online {
    background: #52c41a;
    color: white;
    animation: pulse 2s infinite;
}
.cloud-offline {
    background: #fa8c16;
    color: white;
}
.cloud-error {
    background: #ff4d4f;
    color: white;
}
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}
.sync-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 5px;
}
.sync-green { background: #52c41a; }
.sync-yellow { background: #fa8c16; }
.sync-red { background: #ff4d4f; }
.device-badge {
    background: #1890ff;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    margin-left: 10px;
}
.realtime-notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    border-left: 4px solid #1890ff;
    z-index: 9998;
    animation: slideIn 0.3s ease;
    max-width: 300px;
    display: none;
}
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
.sync-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}
</style>
</head>
<body>
<!-- Cloud status indicator -->
<div id="cloudStatus" class="cloud-status cloud-offline">
    <span class="sync-indicator sync-red"></span>
    <span id="cloudStatusText">äº‘ç«¯ç¦»çº¿</span>
</div>

<!-- Realtime notification -->
<div id="realtimeNotification" class="realtime-notification">
    <div style="font-weight:bold;margin-bottom:5px;">å®æ—¶æ›´æ–°</div>
    <div id="notificationMessage"></div>
</div>

<!-- Auth container -->
<div id="authContainer">
    <div class="auth-header">
        <h1 style="margin:0;font-size:28px">å†›äº‹èŒä½ç®¡ç†ç³»ç»Ÿ</h1>
        <p style="margin:10px 0 0 0;opacity:0.9">æœºå¯†ç³»ç»Ÿ-éœ€éªŒè¯èº«ä»½</p>
    </div>
    <div class="auth-body">
        <div class="auth-title">èº«ä»½éªŒè¯</div>
        <div class="auth-subtitle">è¯·è¾“å…¥è®¿é—®æš—å·ä»¥è¿›å…¥ç³»ç»Ÿ</div>
        <div class="secret-input">
            <span class="secret-icon">ğŸ”</span>
            <input type="text" id="secretCode" placeholder="è¯·è¾“å…¥è®¿é—®æš—å·" autocomplete="off">
        </div>
        <button class="auth-button" onclick="verifySecretCode()">éªŒè¯èº«ä»½</button>
        <div class="auth-note">
            <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong><br>
            æœ¬ç³»ç»Ÿä¸ºæœºå¯†ç®¡ç†ç³»ç»Ÿï¼Œä»…ä¾›æˆæƒäººå‘˜ä½¿ç”¨<br>
            è¯·ç¡®ä¿æ‚¨å·²è·å¾—æ­£ç¡®çš„è®¿é—®æš—å·<br>
            è¿ç»­5æ¬¡è¾“å…¥é”™è¯¯å°†é”å®šç³»ç»Ÿ30åˆ†é’Ÿ
        </div>
        <div class="auth-error" id="authError"></div>
        <div class="auth-success" id="authSuccess">éªŒè¯æˆåŠŸï¼æ­£åœ¨è¿›å…¥ç³»ç»Ÿ...</div>
        <div class="countdown" id="countdown">å‰©ä½™å°è¯•æ¬¡æ•°: <span id="attemptsLeft">5</span> æ¬¡</div>
    </div>
</div>

<!-- Login container (simplified for brevity - includes all original modals and forms) -->
<div class="container" id="loginContainer">
    <div class="header">
        <h1>å†›äº‹èŒä½ç®¡ç†ç³»ç»Ÿ</h1>
        <p>äº‘ç«¯åä½œç‰ˆæœ¬ - Powered by Supabase</p>
    </div>
    <div class="body">
        <div class="tabs" style="margin-bottom:30px">
            <div class="tab active" onclick="showTab(event, 'connect')">è¿æ¥æœåŠ¡å™¨</div>
            <div class="tab" onclick="showTab(event, 'login')">ç”¨æˆ·ç™»å½•</div>
            <div class="tab" onclick="showTab(event, 'cloud')">äº‘ç«¯æœåŠ¡å™¨</div>
        </div>
        
        <div id="connectTab" class="tab-content" style="display:block;">
            <h2 style="margin-bottom:20px">è¿æ¥åˆ°äº‘ç«¯æœåŠ¡å™¨</h2>
            <div class="form-group">
                <label>äº‘ç«¯è®¿é—®ç </label>
                <input type="text" id="quickCloudCode" placeholder="è¾“å…¥äº‘ç«¯è®¿é—®ç ">
            </div>
            <button class="btn" onclick="quickConnectCloud()">å¿«é€Ÿè¿æ¥</button>
            <div class="error" id="quickConnectError"></div>
        </div>
        
        <div id="loginTab" class="tab-content">
            <h2 style="margin-bottom:20px">ç”¨æˆ·ç™»å½•</h2>
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
            </div>
            <button class="btn" onclick="login()">ç™»å½•</button>
            <div class="error" id="loginError"></div>
        </div>
        
        <div id="cloudTab" class="tab-content">
            <h2 style="margin-bottom:20px">åˆ›å»ºæ–°çš„äº‘ç«¯æœåŠ¡å™¨</h2>
            <div class="form-group">
                <label>æœåŠ¡å™¨åç§°</label>
                <input type="text" id="newServerName" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€å†›åŒº">
            </div>
            <div class="form-group">
                <label>äº‘ç«¯è®¿é—®ç </label>
                <input type="text" id="newCloudCode" placeholder="è®¾ç½®è®¿é—®ç ï¼ˆå­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰">
                <small style="color:#666;display:block;margin-top:5px">å…¶ä»–è®¾å¤‡ä½¿ç”¨æ­¤ç è¿æ¥</small>
            </div>
            <div class="form-group">
                <label>ç®¡ç†å‘˜ç”¨æˆ·å</label>
                <input type="text" id="newAdminUser" placeholder="è®¾ç½®ç®¡ç†å‘˜ç”¨æˆ·å">
            </div>
            <div class="form-group">
                <label>ç®¡ç†å‘˜å¯†ç </label>
                <input type="password" id="newAdminPass" placeholder="è‡³å°‘6ä½">
            </div>
            <button class="btn btn-success" onclick="createCloudServer()">åˆ›å»ºäº‘ç«¯æœåŠ¡å™¨</button>
            <div class="error" id="cloudCreateError"></div>
        </div>
    </div>
</div>

<!-- Main system (keeping original structure) -->
<div class="main-container" id="mainContainer">
    <div class="main-header">
        <div>
            <h2>å†›äº‹èŒä½ç®¡ç†ç³»ç»Ÿ <span id="serverTypeBadge" class="device-badge">äº‘ç«¯</span></h2>
            <p style="color:#666;margin-top:5px">
                æœåŠ¡å™¨: <span id="currentServerName">-</span> | 
                ç”¨æˆ·: <span id="currentUserName">-</span> | 
                åŒæ­¥: <span id="syncStatus">-</span>
            </p>
        </div>
        <div>
            <button class="btn" onclick="syncNow()" style="margin-right:10px;width:auto">ğŸ”„ åŒæ­¥</button>
            <button class="btn btn-danger" onclick="logout()" style="width:auto">é€€å‡º</button>
        </div>
    </div>
    
    <div class="tabs">
        <div class="tab active" onclick="showMainTab(event, 'dashboard')">æ§åˆ¶é¢æ¿</div>
        <div class="tab" onclick="showMainTab(event, 'personnel')">äººå‘˜ç®¡ç†</div>
        <div class="tab" onclick="showMainTab(event, 'addPerson')">æ·»åŠ äººå‘˜</div>
        <div class="tab" onclick="showMainTab(event, 'promotion')">æ™‹å‡ç®¡ç†</div>
    </div>
    
    <div class="content">
        <div id="dashboardTab" class="main-tab">
            <h2 style="margin-bottom:20px">ç³»ç»Ÿæ¦‚è§ˆ</h2>
            <div class="stats">
                <div class="stat-card">
                    <div class="number" id="totalUsers">0</div>
                    <div class="label">æ€»äººæ•°</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="activeUsers">0</div>
                    <div class="label">åœ¨å½¹äººå‘˜</div>
                </div>
                <div class="stat-card">
                    <div class="number">6</div>
                    <div class="label">å†›è¡”ç­‰çº§</div>
                </div>
            </div>
            <div id="onlineDevicesSection" style="margin-top:20px;padding:20px;background:#e6f7ff;border-radius:10px">
                <h4 style="margin-bottom:15px">ğŸ–¥ï¸ åœ¨çº¿è®¾å¤‡: <span id="deviceCount">0</span></h4>
                <div id="onlineDevicesList"></div>
            </div>
        </div>
        
        <div id="personnelTab" class="main-tab" style="display:none">
            <h2 style="margin-bottom:20px">äººå‘˜ç®¡ç†</h2>
            <table>
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>å†›è¡”</th>
                        <th>çŠ¶æ€</th>
                        <th>åŠ å…¥æ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="personnelList"></tbody>
            </table>
        </div>
        
        <div id="addPersonTab" class="main-tab" style="display:none">
            <h2 style="margin-bottom:20px">æ·»åŠ äººå‘˜</h2>
            <div style="max-width:500px">
                <div class="form-group">
                    <label>å§“å</label>
                    <input type="text" id="newName" placeholder="è¾“å…¥äººå‘˜å§“å">
                </div>
                <div class="form-group">
                    <label>åˆå§‹å¯†ç </label>
                    <input type="text" id="newPassword" placeholder="è®¾ç½®åˆå§‹å¯†ç ">
                </div>
                <div class="form-group">
                    <label>åˆå§‹å†›è¡”</label>
                    <select id="newRank">
                        <option value="0">åºŸç‰©</option>
                        <option value="1">å°å…µ</option>
                        <option value="2">å¤§å…µ</option>
                        <option value="3">å›¢é•¿</option>
                        <option value="4">å†›é•¿</option>
                        <option value="5">ä¸»å¸…</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="addNewPerson()">æ·»åŠ äººå‘˜</button>
                <div class="error" id="addError"></div>
            </div>
        </div>
        
        <div id="promotionTab" class="main-tab" style="display:none">
            <h2 style="margin-bottom:20px">æ™‹å‡ç®¡ç†</h2>
            <div style="max-width:500px">
                <div class="form-group">
                    <label>é€‰æ‹©äººå‘˜</label>
                    <select id="promotePerson">
                        <option value="">è¯·é€‰æ‹©äººå‘˜</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ“ä½œç±»å‹</label>
                    <select id="promoteAction">
                        <option value="up">æ™‹å‡ä¸€çº§</option>
                        <option value="down">é™çº§ä¸€çº§</option>
                    </select>
                </div>
                <div id="promoteInfo" style="padding:15px;background:#f6ffed;border-radius:5px;margin-bottom:20px;display:none">
                    <p><strong>å½“å‰å†›è¡”:</strong> <span id="currentRankText">-</span></p>
                    <p><strong>æ“ä½œåå†›è¡”:</strong> <span id="newRankText">-</span></p>
                </div>
                <button class="btn" onclick="promotePerson()">æ‰§è¡Œæ“ä½œ</button>
                <div class="error" id="promoteError"></div>
            </div>
        </div>
    </div>
</div>

<!-- Lock screen -->
<div id="lockScreen" class="locked-screen" style="display:none">
    <div class="lock-icon">ğŸ”’</div>
    <h2 style="margin-bottom:15px">ç³»ç»Ÿå·²é”å®š</h2>
    <div class="lock-message">
        ç”±äºè¿ç»­å¤šæ¬¡è¾“å…¥é”™è¯¯æš—å·ï¼Œç³»ç»Ÿå·²è¢«é”å®šã€‚<br>
        è¯·åœ¨ <span id="lockTime">30:00</span> åé‡è¯•ã€‚
    </div>
    <button class="btn" onclick="checkLockStatus()" style="background:#d32f2f;color:white;border:none;padding:12px 30px;border-radius:5px;font-size:16px;cursor:pointer">é‡æ–°éªŒè¯</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ==================== SUPABASE CONFIGURATION ====================
// TODO: Replace with your own Supabase credentials
const SUPABASE_URL = 'https://kbotukqvzizsupsqqrdl.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtib3R1a3F2eml6c3Vwc3FxcmRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMzE3NDksImV4cCI6MjA4NTgwNzc0OX0.F2kow6WgrQVZaSBsOqGjPLMAkLyv0XTqg2iyTy4b1Fes';

// Initialize Supabase client
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ==================== SYSTEM CONFIGURATION ====================
const SECRET_CODE = "èµµå·¦å´è”ç›Ÿ";
const MAX_ATTEMPTS = 5;
const LOCK_TIME = 30 * 60 * 1000;
const ranks = [
    {id:0, name:"åºŸç‰©", color:"#8c8c8c"},
    {id:1, name:"å°å…µ", color:"#52c41a"},
    {id:2, name:"å¤§å…µ", color:"#1890ff"},
    {id:3, name:"å›¢é•¿", color:"#722ed1"},
    {id:4, name:"å†›é•¿", color:"#fa8c16"},
    {id:5, name:"ä¸»å¸…", color:"#f5222d"},
    {id:99, name:"ç®¡ç†å‘˜", color:"#eb2f96"}
];

// Global variables
let currentUser = null;
let currentServer = null;
let serverData = { info: null, users: [], logs: [], devices: [] };
let secretVerified = false;
let failedAttempts = 0;
let lockUntil = 0;
let deviceId = null;
let syncIntervalId = null;
let realtimeChannel = null;

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', async function() {
    console.log('ç³»ç»Ÿåˆå§‹åŒ–...');
    deviceId = generateDeviceId();
    checkLockStatus();
    loadAttempts();
    
    // Setup event listeners
    document.getElementById('secretCode').addEventListener('keypress', e => {
        if (e.key === 'Enter') verifySecretCode();
    });
    document.getElementById('secretCode').focus();
});

function generateDeviceId() {
    let savedId = localStorage.getItem('military_device_id');
    if (savedId) return savedId;
    
    savedId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('military_device_id', savedId);
    return savedId;
}

// ==================== AUTHENTICATION ====================
function verifySecretCode() {
    if (!checkLockStatus()) return;
    
    const inputCode = document.getElementById('secretCode').value.trim();
    const errorDiv = document.getElementById('authError');
    const successDiv = document.getElementById('authSuccess');
    
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';
    
    if (!inputCode) {
        errorDiv.textContent = 'è¯·è¾“å…¥è®¿é—®æš—å·';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (inputCode === SECRET_CODE) {
        secretVerified = true;
        successDiv.textContent = 'éªŒè¯æˆåŠŸï¼æ­£åœ¨è¿›å…¥ç³»ç»Ÿ...';
        successDiv.style.display = 'block';
        failedAttempts = 0;
        saveAttempts();
        updateAttemptsDisplay();
        
        setTimeout(() => {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'block';
        }, 1000);
    } else {
        failedAttempts++;
        saveAttempts();
        const attemptsLeft = MAX_ATTEMPTS - failedAttempts;
        
        if (attemptsLeft <= 0) {
            errorDiv.textContent = 'æš—å·é”™è¯¯æ¬¡æ•°è¿‡å¤šï¼Œç³»ç»Ÿå·²é”å®š30åˆ†é’Ÿï¼';
            errorDiv.style.display = 'block';
            lockSystem();
        } else {
            errorDiv.textContent = `æš—å·é”™è¯¯ï¼å‰©ä½™å°è¯•æ¬¡æ•°: ${attemptsLeft} æ¬¡`;
            errorDiv.style.display = 'block';
            document.getElementById('secretCode').value = '';
            updateAttemptsDisplay();
        }
    }
}

// ==================== CLOUD SERVER FUNCTIONS ====================
async function quickConnectCloud() {
    const cloudCode = document.getElementById('quickCloudCode').value.trim();
    const errorDiv = document.getElementById('quickConnectError');
    errorDiv.style.display = 'none';
    
    if (!cloudCode) {
        errorDiv.textContent = 'è¯·è¾“å…¥äº‘ç«¯è®¿é—®ç ';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        updateCloudStatus('connecting', 'æ­£åœ¨è¿æ¥...');
        
        const serverCheck = await supabaseClient
            .from('servers')
            .select('*')
            .eq('cloud_code', cloudCode)
            .single();
        
        if (serverCheck.error || !serverCheck.data) {
            errorDiv.textContent = 'äº‘ç«¯è®¿é—®ç ä¸å­˜åœ¨';
            errorDiv.style.display = 'block';
            updateCloudStatus('offline', 'è¿æ¥å¤±è´¥');
            return;
        }
        
        currentServer = {
            id: serverCheck.data.id,
            key: serverCheck.data.cloud_code,
            name: serverCheck.data.name,
            type: 'cloud'
        };
        
        await loadServerData(serverCheck.data.id);
        
        showTab({target: document.querySelectorAll('.tab')[1]}, 'login');
        showNotification('å·²è¿æ¥åˆ°äº‘ç«¯æœåŠ¡å™¨: ' + serverCheck.data.name);
        updateCloudStatus('online', 'äº‘ç«¯å·²è¿æ¥');
        
    } catch (error) {
        console.error('è¿æ¥å¤±è´¥:', error);
        errorDiv.textContent = 'è¿æ¥å¤±è´¥: ' + error.message;
        errorDiv.style.display = 'block';
        updateCloudStatus('offline', 'è¿æ¥å¤±è´¥');
    }
}

async function createCloudServer() {
    const serverName = document.getElementById('newServerName').value.trim();
    const cloudCode = document.getElementById('newCloudCode').value.trim();
    const adminUser = document.getElementById('newAdminUser').value.trim();
    const adminPass = document.getElementById('newAdminPass').value.trim();
    const errorDiv = document.getElementById('cloudCreateError');
    errorDiv.style.display = 'none';
    
    if (!serverName || !cloudCode || !adminUser || !adminPass) {
        errorDiv.textContent = 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µ';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (!/^[a-zA-Z0-9_]+$/.test(cloudCode)) {
        errorDiv.textContent = 'è®¿é—®ç åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (adminPass.length < 6) {
        errorDiv.textContent = 'å¯†ç è‡³å°‘éœ€è¦6ä½';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        updateCloudStatus('connecting', 'æ­£åœ¨åˆ›å»º...');
        
        // Check if cloud code exists
        const existingCheck = await supabaseClient
            .from('servers')
            .select('id')
            .eq('cloud_code', cloudCode)
            .single();
        
        if (existingCheck.data && !existingCheck.error) {
            if (!confirm('è¯¥è®¿é—®ç å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ')) {
                updateCloudStatus('offline', 'åˆ›å»ºå–æ¶ˆ');
                return;
            }
            await supabaseClient.from('servers').delete().eq('id', existingCheck.data.id);
            await supabaseClient.from('users').delete().eq('server_id', existingCheck.data.id);
            await supabaseClient.from('logs').delete().eq('server_id', existingCheck.data.id);
        }
        
        const adminId = 'user_' + Date.now();
        
        // Create server
        const serverResult = await supabaseClient
            .from('servers')
            .insert({
                name: serverName,
                cloud_code: cloudCode,
                created_by: adminUser,
                creator_id: adminId
            })
            .select()
            .single();
        
        if (serverResult.error) throw serverResult.error;
        const server = serverResult.data;
        
        // Create admin user
        const userResult = await supabaseClient
            .from('users')
            .insert({
                id: adminId,
                server_id: server.id,
                username: adminUser,
                password: adminPass,
                rank: 99,
                is_admin: true,
                name: 'ç®¡ç†å‘˜'
            });
        
        if (userResult.error) throw userResult.error;
        
        // Create log
        await supabaseClient
            .from('logs')
            .insert({
                server_id: server.id,
                action: 'server_created',
                user: adminUser,
                details: `äº‘ç«¯æœåŠ¡å™¨ "${serverName}" å·²åˆ›å»º`
            });
        
        currentServer = {
            id: server.id,
            key: cloudCode,
            name: serverName,
            type: 'cloud'
        };
        
        await loadServerData(server.id);
        
        currentUser = serverData.users.find(u => u.username === adminUser);
        
        await updateDeviceStatus();
        startRealtimeSync();
        
        document.getElementById('loginContainer').style.display = 'none';
        showMainSystem();
        
        showNotification('äº‘ç«¯æœåŠ¡å™¨åˆ›å»ºæˆåŠŸï¼è®¿é—®ç : ' + cloudCode);
        updateCloudStatus('online', 'äº‘ç«¯å·²è¿æ¥');
        
    } catch (error) {
        console.error('åˆ›å»ºå¤±è´¥:', error);
        errorDiv.textContent = 'åˆ›å»ºå¤±è´¥: ' + error.message;
        errorDiv.style.display = 'block';
        updateCloudStatus('offline', 'åˆ›å»ºå¤±è´¥');
    }
}

async function login() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    const errorDiv = document.getElementById('loginError');
    errorDiv.style.display = 'none';
    
    if (!username || !password) {
        errorDiv.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        const user = serverData.users.find(u => u.username === username && u.password === password);
        
        if (!user) {
            errorDiv.textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
            errorDiv.style.display = 'block';
            return;
        }
        
        currentUser = user;
        
        // Update last login
        await supabaseClient
            .from('users')
            .update({ last_login: new Date().toISOString() })
            .eq('id', user.id);
        
        await updateDeviceStatus();
        await addLog('user_login', username, `ç”¨æˆ· ${username} ç™»å½•ç³»ç»Ÿ`);
        
        startRealtimeSync();
        showMainSystem();
        
    } catch (error) {
        console.error('ç™»å½•å¤±è´¥:', error);
        errorDiv.textContent = 'ç™»å½•å¤±è´¥: ' + error.message;
        errorDiv.style.display = 'block';
    }
}

// ==================== DATA SYNC FUNCTIONS ====================
async function loadServerData(serverId) {
    try {
        // Load users
        const usersResult = await supabaseClient
            .from('users')
            .select('*')
            .eq('server_id', serverId);
        
        if (usersResult.error) throw usersResult.error;
        
        // Load logs
        const logsResult = await supabaseClient
            .from('logs')
            .select('*')
            .eq('server_id', serverId)
            .order('created_at', { ascending: false })
            .limit(100);
        
        if (logsResult.error) throw logsResult.error;
        
        // Load devices
        const devicesResult = await supabaseClient
            .from('devices')
            .select('*')
            .eq('server_id', serverId)
            .gte('last_seen', new Date(Date.now() - 5 * 60 * 1000).toISOString());
        
        serverData = {
            info: currentServer,
            users: usersResult.data || [],
            logs: logsResult.data || [],
            devices: devicesResult.data || []
        };
        
    } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
        throw error;
    }
}

async function updateDeviceStatus() {
    if (!currentServer || !currentUser) return;
    
    try {
        await supabaseClient
            .from('devices')
            .upsert({
                id: deviceId,
                server_id: currentServer.id,
                user: currentUser.username,
                last_seen: new Date().toISOString(),
                online: true
            });
        
        await loadOnlineDevices();
    } catch (error) {
        console.error('æ›´æ–°è®¾å¤‡çŠ¶æ€å¤±è´¥:', error);
    }
}

async function loadOnlineDevices() {
    if (!currentServer) return;
    
    try {
        const devicesResult = await supabaseClient
            .from('devices')
            .select('*')
            .eq('server_id', currentServer.id)
            .gte('last_seen', new Date(Date.now() - 5 * 60 * 1000).toISOString())
            .eq('online', true);
        
        if (devicesResult.error) throw devicesResult.error;
        
        serverData.devices = devicesResult.data || [];
        updateOnlineDevicesDisplay();
        
    } catch (error) {
        console.error('åŠ è½½åœ¨çº¿è®¾å¤‡å¤±è´¥:', error);
    }
}

function updateOnlineDevicesDisplay() {
    const devicesList = document.getElementById('onlineDevicesList');
    const deviceCount = document.getElementById('deviceCount');
    
    deviceCount.textContent = serverData.devices.length;
    
    devicesList.innerHTML = serverData.devices.map(device => `
        <div style="padding:10px;border-bottom:1px solid #d9d9d9;display:flex;justify-content:space-between">
            <div>
                <strong>${device.user}</strong>
                <div style="font-size:12px;color:#666">${device.id === deviceId ? 'å½“å‰è®¾å¤‡' : 'å…¶ä»–è®¾å¤‡'}</div>
            </div>
            <div style="font-size:12px;color:#52c41a">
                â— åœ¨çº¿
            </div>
        </div>
    `).join('');
}

function startRealtimeSync() {
    if (!currentServer) return;
    
    // Subscribe to realtime changes
    realtimeChannel = supabaseClient
        .channel(`server_${currentServer.id}`)
        .on('postgres_changes', 
            { event: '*', schema: 'public', table: 'users', filter: `server_id=eq.${currentServer.id}` },
            async (payload) => {
                console.log('Users changed:', payload);
                await loadServerData(currentServer.id);
                updateDashboard();
                showNotification('æ•°æ®å·²æ›´æ–°');
            }
        )
        .on('postgres_changes',
            { event: '*', schema: 'public', table: 'devices', filter: `server_id=eq.${currentServer.id}` },
            async (payload) => {
                await loadOnlineDevices();
            }
        )
        .subscribe();
    
    // Periodic device heartbeat
    syncIntervalId = setInterval(async () => {
        await updateDeviceStatus();
    }, 30000); // Every 30 seconds
    
    updateCloudStatus('online', 'äº‘ç«¯å·²è¿æ¥');
}

async function syncNow() {
    if (!currentServer) return;
    
    try {
        showNotification('æ­£åœ¨åŒæ­¥...');
        await loadServerData(currentServer.id);
        await updateDeviceStatus();
        updateDashboard();
        document.getElementById('syncStatus').textContent = 'å·²åŒæ­¥';
        showNotification('åŒæ­¥å®Œæˆ');
    } catch (error) {
        console.error('åŒæ­¥å¤±è´¥:', error);
        showNotification('åŒæ­¥å¤±è´¥');
    }
}

// ==================== PERSONNEL MANAGEMENT ====================
async function addNewPerson() {
    const name = document.getElementById('newName').value.trim();
    const password = document.getElementById('newPassword').value.trim();
    const rank = parseInt(document.getElementById('newRank').value);
    const errorDiv = document.getElementById('addError');
    errorDiv.style.display = 'none';
    
    if (!name || !password) {
        errorDiv.textContent = 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µ';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (password.length < 3) {
        errorDiv.textContent = 'å¯†ç è‡³å°‘3ä½';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 8);
        const username = 'user' + Date.now();
        
        const insertResult = await supabaseClient
            .from('users')
            .insert({
                id: userId,
                server_id: currentServer.id,
                username: username,
                password: password,
                name: name,
                rank: rank,
                is_admin: false
            });
        
        if (insertResult.error) throw insertResult.error;
        
        await addLog('add_person', currentUser.username, `æ·»åŠ æ–°äººå‘˜: ${name}ï¼Œå†›è¡”: ${getRankName(rank)}`);
        await loadServerData(currentServer.id);
        
        alert(`æ·»åŠ æˆåŠŸï¼\nå§“å: ${name}\nç”¨æˆ·å: ${username}\nå¯†ç : ${password}`);
        
        document.getElementById('newName').value = '';
        document.getElementById('newPassword').value = '';
        updateDashboard();
        
    } catch (error) {
        console.error('æ·»åŠ å¤±è´¥:', error);
        errorDiv.textContent = 'æ·»åŠ å¤±è´¥: ' + error.message;
        errorDiv.style.display = 'block';
    }
}

async function promotePerson() {
    const userId = document.getElementById('promotePerson').value;
    const action = document.getElementById('promoteAction').value;
    const errorDiv = document.getElementById('promoteError');
    errorDiv.style.display = 'none';
    
    if (!userId) {
        errorDiv.textContent = 'è¯·é€‰æ‹©äººå‘˜';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        const user = serverData.users.find(u => u.id === userId);
        if (!user) throw new Error('ç”¨æˆ·ä¸å­˜åœ¨');
        
        let newRank = user.rank;
        if (action === 'up' && user.rank < 5) {
            newRank = user.rank + 1;
        } else if (action === 'down' && user.rank > 0) {
            newRank = user.rank - 1;
        }
        
        const { error } = await supabaseClient
            .from('users')
            .update({ rank: newRank })
            .eq('id', userId);
        
        if (error) throw error;
        
        await addLog('promote', currentUser.username, 
            `${action === 'up' ? 'æ™‹å‡' : 'é™çº§'} ${user.name} ä» ${getRankName(user.rank)} åˆ° ${getRankName(newRank)}`);
        
        await loadServerData(currentServer.id);
        
        alert(`æ“ä½œæˆåŠŸï¼${user.name} ä» ${getRankName(user.rank)} å˜ä¸º ${getRankName(newRank)}`);
        loadPromoteList();
        
    } catch (error) {
        console.error('æ“ä½œå¤±è´¥:', error);
        errorDiv.textContent = 'æ“ä½œå¤±è´¥: ' + error.message;
        errorDiv.style.display = 'block';
    }
}

async function addLog(action, user, details) {
    try {
        await supabaseClient
            .from('logs')
            .insert({
                server_id: currentServer.id,
                action: action,
                user: user,
                details: details
            });
    } catch (error) {
        console.error('æ·»åŠ æ—¥å¿—å¤±è´¥:', error);
    }
}

// ==================== UI FUNCTIONS ====================
function showMainSystem() {
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('mainContainer').style.display = 'block';
    
    document.getElementById('currentServerName').textContent = currentServer.name;
    document.getElementById('currentUserName').textContent = currentUser.name || currentUser.username;
    
    updateDashboard();
}

function updateDashboard() {
    if (!serverData.users) return;
    
    document.getElementById('totalUsers').textContent = serverData.users.length;
    document.getElementById('activeUsers').textContent = serverData.users.filter(u => !u.is_admin).length;
    
    updateOnlineDevicesDisplay();
}

function loadPersonnelList() {
    const personnelList = document.getElementById('personnelList');
    personnelList.innerHTML = '';
    
    serverData.users.forEach(user => {
        if (user.rank < currentUser.rank && user.id !== currentUser.id) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.name || user.username}</td>
                <td><span style="color:${getRankColor(user.rank)};font-weight:bold">${getRankName(user.rank)}</span></td>
                <td>${user.is_admin ? '<span style="color:#52c41a">ç®¡ç†å‘˜</span>' : '<span style="color:#1890ff">æ™®é€š</span>'}</td>
                <td>${new Date(user.created_at).toLocaleDateString('zh-CN')}</td>
                <td>
                    <button class="action-btn action-btn-primary" onclick="alert('æŸ¥çœ‹: ${user.name}')">æŸ¥çœ‹</button>
                </td>
            `;
            personnelList.appendChild(row);
        }
    });
}

function loadPromoteList() {
    const promoteSelect = document.getElementById('promotePerson');
    promoteSelect.innerHTML = '<option value="">è¯·é€‰æ‹©äººå‘˜</option>';
    
    serverData.users.forEach(user => {
        if (user.rank < currentUser.rank && user.id !== currentUser.id && !user.is_admin) {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = `${user.name || user.username} (${getRankName(user.rank)})`;
            promoteSelect.appendChild(option);
        }
    });
}

function showTab(event, tabName) {
    const tabs = document.querySelectorAll('#loginContainer .tab');
    tabs.forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');
    
    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(content => content.style.display = 'none');
    
    document.getElementById(tabName + 'Tab').style.display = 'block';
}

function showMainTab(event, tabName) {
    const mainTabs = document.querySelectorAll('.main-tab');
    mainTabs.forEach(tab => tab.style.display = 'none');
    
    const tabs = document.querySelectorAll('.main-container .tab');
    tabs.forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');
    
    document.getElementById(tabName + 'Tab').style.display = 'block';
    
    if (tabName === 'personnel') loadPersonnelList();
    if (tabName === 'promotion') loadPromoteList();
}

async function logout() {
    if (!confirm('ç¡®å®šé€€å‡ºå—ï¼Ÿ')) return;
    
    try {
        if (deviceId && currentServer) {
            await supabaseClient
                .from('devices')
                .update({ online: false })
                .eq('id', deviceId);
        }
        
        if (realtimeChannel) {
            supabaseClient.removeChannel(realtimeChannel);
        }
        
        if (syncIntervalId) {
            clearInterval(syncIntervalId);
        }
        
        currentUser = null;
        currentServer = null;
        serverData = { info: null, users: [], logs: [], devices: [] };
        
        document.getElementById('mainContainer').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'block';
        
        updateCloudStatus('offline', 'äº‘ç«¯ç¦»çº¿');
        
    } catch (error) {
        console.error('é€€å‡ºå¤±è´¥:', error);
    }
}

// ==================== HELPER FUNCTIONS ====================
function getRankName(rankId) {
    const rank = ranks.find(r => r.id === rankId);
    return rank ? rank.name : 'æœªçŸ¥';
}

function getRankColor(rankId) {
    const rank = ranks.find(r => r.id === rankId);
    return rank ? rank.color : '#8c8c8c';
}

function showNotification(message) {
    const notification = document.getElementById('realtimeNotification');
    const messageDiv = document.getElementById('notificationMessage');
    
    messageDiv.textContent = message;
    notification.style.display = 'block';
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

function updateCloudStatus(status, message) {
    const cloudStatus = document.getElementById('cloudStatus');
    const statusText = document.getElementById('cloudStatusText');
    const indicator = cloudStatus.querySelector('.sync-indicator');
    
    if (status === 'online') {
        cloudStatus.className = 'cloud-status cloud-online';
        indicator.className = 'sync-indicator sync-green';
    } else if (status === 'connecting') {
        cloudStatus.className = 'cloud-status cloud-status';
        cloudStatus.style.background = '#fa8c16';
        indicator.className = 'sync-indicator sync-yellow';
    } else {
        cloudStatus.className = 'cloud-status cloud-offline';
        indicator.className = 'sync-indicator sync-red';
    }
    
    statusText.textContent = message;
}

// Lock system functions
function checkLockStatus() {
    const now = Date.now();
    const lockData = localStorage.getItem('system_lock');
    
    if (lockData) {
        const lockInfo = JSON.parse(lockData);
        lockUntil = lockInfo.lockUntil;
        
        if (now < lockUntil) {
            showLockScreen(lockUntil - now);
            return false;
        } else {
            localStorage.removeItem('system_lock');
            localStorage.removeItem('failed_attempts');
            failedAttempts = 0;
            updateAttemptsDisplay();
            return true;
        }
    }
    
    return true;
}

function lockSystem() {
    lockUntil = Date.now() + LOCK_TIME;
    localStorage.setItem('system_lock', JSON.stringify({
        lockUntil: lockUntil,
        lockedAt: new Date().toISOString()
    }));
    showLockScreen(LOCK_TIME);
}

function showLockScreen(remainingTime) {
    const lockScreen = document.getElementById('lockScreen');
    const lockTimeSpan = document.getElementById('lockTime');
    
    lockScreen.style.display = 'flex';
    document.getElementById('authContainer').style.display = 'none';
    
    function updateCountdown() {
        const now = Date.now();
        const timeLeft = lockUntil - now;
        
        if (timeLeft <= 0) {
            lockScreen.style.display = 'none';
            document.getElementById('authContainer').style.display = 'block';
            return;
        }
        
        const minutes = Math.floor(timeLeft / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);
        lockTimeSpan.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        setTimeout(updateCountdown, 1000);
    }
    
    updateCountdown();
}

function loadAttempts() {
    const attemptsData = localStorage.getItem('failed_attempts');
    failedAttempts = attemptsData ? parseInt(attemptsData) || 0 : 0;
    updateAttemptsDisplay();
}

function saveAttempts() {
    localStorage.setItem('failed_attempts', failedAttempts.toString());
}

function updateAttemptsDisplay() {
    const attemptsLeft = MAX_ATTEMPTS - failedAttempts;
    document.getElementById('attemptsLeft').textContent = attemptsLeft;
}
</script>
</body>
</html>
